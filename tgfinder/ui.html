<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb}
    header{background:#111827;color:#fff;padding:14px 16px}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{padding:12px;max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:12px;color:#374151;display:block;margin-bottom:4px}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:#fff}
    input[type="number"]{width:100px}
    button{padding:8px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;font-size:13px;cursor:pointer}
    button:disabled{opacity:.5}
    button.secondary{background:#e5e7eb;color:#374151}
    button.small{padding:5px 10px;font-size:11px}
    .tabs{display:flex;flex-wrap:wrap;background:#fff;border-radius:12px 12px 0 0;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .tab{flex:1 1 auto;padding:10px 8px;text-align:center;cursor:pointer;font-weight:600;font-size:12px;color:#6b7280;border-bottom:3px solid transparent;min-width:fit-content}
    .tab:hover{background:#f9fafb}
    .tab.active{color:#2563eb;border-bottom-color:#2563eb}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card.no-top{border-radius:0 0 12px 12px;margin-top:0}
    .meta{color:#6b7280;font-size:12px}
    .error{color:#b91c1c;font-size:13px}
    .results{margin-top:10px}
    .hit{border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-top:8px}
    .ref{font-weight:700;color:#111827}
    .pill{display:inline-block;padding:2px 6px;border-radius:99px;background:#eef2ff;color:#3730a3;font-size:11px;margin-inline-start:6px}
    .text{margin-top:6px;font-size:15px;line-height:1.6}
    /* Histogram */
    .hist-section{margin-bottom:16px}
    .hist-section h3{margin:0 0 8px;font-size:14px;color:#374151;display:flex;align-items:center;gap:8px}
    .hist-section h3 .back-btn{font-size:12px}
    .histogram{display:flex;align-items:flex-end;gap:2px;min-height:150px;padding:8px 4px;background:#f9fafb;border-radius:8px;overflow-x:auto}
    .histogram.overview{min-height:120px}
    .histogram.detail{min-height:180px}
    .bar{background:linear-gradient(to top,#2563eb,#60a5fa);border-radius:3px 3px 0 0;cursor:pointer;transition:all .15s;position:relative;min-width:20px;flex-shrink:0}
    .bar:hover{background:linear-gradient(to top,#1d4ed8,#3b82f6);transform:scaleY(1.03)}
    .bar.selected{background:linear-gradient(to top,#dc2626,#f87171)}
    .bar-label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:#6b7280;white-space:nowrap}
    .bar-count{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:9px;color:#374151;font-weight:600}
    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .stat{background:#eef2ff;padding:6px 12px;border-radius:8px}
    .stat b{color:#2563eb;font-size:16px}
    .stat span{font-size:11px;color:#6b7280;display:block}
    .hint{font-size:11px;color:#6b7280;margin-top:6px}
    .loading{text-align:center;padding:30px;color:#6b7280}
    .spinner{border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto 8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .no-data{text-align:center;padding:20px;color:#9ca3af}
    .jump-input{display:flex;gap:6px;align-items:center;margin-top:8px}
    .jump-input input{width:80px}
    .top-values{margin-bottom:12px;padding:10px;background:#fefce8;border-radius:8px;border:1px solid #fef08a}
    .top-values h4{margin:0 0 8px;font-size:13px;color:#854d0e}
    .top-chips{display:flex;gap:6px;flex-wrap:wrap}
    .top-chip{background:#fef9c3;border:1px solid #fde047;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .15s}
    .top-chip:hover{background:#fde047}
    .top-chip b{color:#a16207;margin-left:4px}
    /* Modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;justify-content:center;align-items:center;padding:16px}
    .modal-bg.visible{display:flex}
    .modal{background:#fff;border-radius:14px;max-width:480px;width:100%;max-height:75vh;display:flex;flex-direction:column}
    .modal-head{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-head h3{margin:0;font-size:16px}
    .modal-close{background:#f3f4f6;border:0;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px}
    .modal-body{padding:12px 16px;overflow-y:auto;flex:1}
    .modal-item{padding:10px;margin:6px 0;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid transparent}
    .modal-item:hover{background:#eef2ff;border-color:#2563eb}
    .modal-ref{font-weight:600;color:#2563eb;margin-bottom:4px}
    .modal-text{font-size:13px;color:#374151;line-height:1.5}
    .modal-word{background:#dbeafe;padding:2px 6px;border-radius:4px;font-weight:600;margin-left:6px;font-size:12px}
    mark{background:#fef08a;padding:1px 4px;border-radius:3px;font-weight:600}
    .expandable{cursor:pointer}
    .expandable-content{display:none;margin-top:8px;padding:10px;background:#f9fafb;border-radius:8px;font-size:18px;line-height:2}
    .expandable-content.open{display:block}
    .expand-btn{font-size:11px;color:#2563eb;margin-right:8px}
    .els-letter{background:#dc2626;color:#fff;padding:0 2px;border-radius:2px;font-weight:700}
    /* Multi-select book dropdown */
    .book-select{position:relative;width:200px}
    .book-select-btn{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;background:#fff;text-align:right;cursor:pointer;font-size:14px;display:flex;justify-content:space-between;align-items:center}
    .book-select-btn:hover{background:#f9fafb}
    .book-select-dropdown{display:none;position:absolute;top:100%;right:0;width:280px;max-height:400px;overflow-y:auto;background:#fff;border:1px solid #d1d5db;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;margin-top:4px}
    .book-select-dropdown.open{display:block}
    .book-select-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .book-select-item:hover{background:#f3f4f6}
    .book-select-item input[type="checkbox"]{margin:0;cursor:pointer}
    .book-select-item label{cursor:pointer;flex:1;margin:0}
    .book-select-item.all{font-weight:700;border-bottom:1px solid #e5e7eb;background:#f9fafb}
    .book-select-item.group{font-weight:600;background:#eef2ff;color:#3730a3;padding-right:12px}
    .book-select-item.book{padding-right:24px}
    .book-select-count{font-size:11px;color:#6b7280}
  </style>
</head>
<body>
<header><h1>ğŸ”¢ ×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</h1></header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="search">ğŸ” ×—×™×¤×•×©</div>
    <div class="tab" data-tab="histogram">ğŸ“Š ×¤×¡×•×§×™×</div>
    <div class="tab" data-tab="histogramWords">ğŸ“Š ××™×œ×™×</div>
    <div class="tab" data-tab="wordCount">ğŸ”¢ ×¡×¤×™×¨×ª ××™×œ×™×</div>
    <div class="tab" data-tab="roshei">××´×ª ×¨××©×™/×¡×•×¤×™</div>
    <div class="tab" data-tab="els">×“×™×œ×•×’ ××•×ª×™×•×ª</div>
    <div class="tab" data-tab="letterSearch">ğŸ”¤ ××•×ª ×¤×•×ª×—×ª/×¡×•×’×¨×ª</div>
    <div class="tab" data-tab="kabbalah">âœ¡ï¸ ××•×©×’×™ ×§×‘×œ×”</div>
    <div class="tab" data-tab="textSearch">ğŸ“ ×—×™×¤×•×© ×‘×˜×§×¡×˜</div>
  </div>

  <!-- Search -->
  <div id="searchTab" class="tab-content active">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××¦×‘</label>
          <select id="mode"><option value="number">××¡×¤×¨</option><option value="text">×˜×§×¡×˜</option></select>
        </div>
        <div id="numWrap">
          <label>×’×™××˜×¨×™×”</label>
          <input id="value" type="number" min="0" placeholder="347">
        </div>
        <div id="txtWrap" style="display:none">
          <label>×˜×§×¡×˜</label>
          <input id="text" type="text" placeholder="×©×œ×•×" style="width:150px">
        </div>
        <div>
          <label>×¡×•×’</label>
          <select id="kind"><option value="">×”×›×•×œ</option><option value="verse">×¤×¡×•×§×™×</option><option value="word">××™×œ×™×</option></select>
        </div>
        <div>
          <label>×¡×¤×¨×™×</label>
          <div id="bookSelect"></div>
        </div>
        <div><label>&nbsp;</label><button id="btn">×—×¤×©</button></div>
      </div>
      <div id="calc" class="hint" style="display:none"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div class="meta" id="status">××•×›×Ÿ</div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <!-- Verses Histogram -->
  <div id="histogramTab" class="tab-content">
    <div class="card no-top">
      <div id="vStats" class="stats"></div>

      <div id="vTopSection" class="top-values"></div>

      <div class="hist-section">
        <h3>ğŸ“Š ×ª××•× ×” ×›×œ×œ×™×ª <span class="hint">(×œ×—×¥ ×¢×œ ×˜×•×•×— ×œ×¤×™×¨×•×˜)</span></h3>
        <div id="vOverview" class="histogram overview"></div>
      </div>

      <div id="vDetailSection" class="hist-section" style="display:none">
        <h3>
          <button class="secondary small back-btn" onclick="hideDetail('verses')">â† ×—×–×•×¨</button>
          <span id="vDetailTitle">×¤×™×¨×•×˜</span>
        </h3>
        <div id="vDetail" class="histogram detail"></div>
      </div>

      <div class="jump-input">
        <label>×§×¤×•×¥ ×œ×’×™××˜×¨×™×”:</label>
        <input type="number" id="vJump" placeholder="500">
        <button class="small" onclick="jumpTo('verses')">××¦×</button>
      </div>

      <div id="vLoading" class="loading"><div class="spinner"></div>×˜×•×¢×Ÿ...</div>
    </div>
  </div>

  <!-- Words Histogram -->
  <div id="histogramWordsTab" class="tab-content">
    <div class="card no-top">
      <div id="wStats" class="stats"></div>

      <div id="wTopSection" class="top-values"></div>

      <div class="hist-section">
        <h3>ğŸ“Š ×ª××•× ×” ×›×œ×œ×™×ª <span class="hint">(×œ×—×¥ ×¢×œ ×˜×•×•×— ×œ×¤×™×¨×•×˜)</span></h3>
        <div id="wOverview" class="histogram overview"></div>
      </div>

      <div id="wDetailSection" class="hist-section" style="display:none">
        <h3>
          <button class="secondary small back-btn" onclick="hideDetail('words')">â† ×—×–×•×¨</button>
          <span id="wDetailTitle">×¤×™×¨×•×˜</span>
        </h3>
        <div id="wDetail" class="histogram detail"></div>
      </div>

      <div class="jump-input">
        <label>×§×¤×•×¥ ×œ×’×™××˜×¨×™×”:</label>
        <input type="number" id="wJump" placeholder="50">
        <button class="small" onclick="jumpTo('words')">××¦×</button>
      </div>

      <div id="wLoading" class="loading"><div class="spinner"></div>×˜×•×¢×Ÿ...</div>
    </div>
  </div>

  <!-- Word Count -->
  <div id="wordCountTab" class="tab-content">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××™×œ×” ×œ×—×™×¤×•×©</label>
          <input id="wcWord" type="text" placeholder="×©×œ×•×" style="width:180px">
        </div>
        <div>
          <label>×¡×¤×¨×™×</label>
          <div id="wcBookSelect"></div>
        </div>
        <div><label>&nbsp;</label><button id="wcBtn">×—×¤×©</button></div>
      </div>
      <div id="wcErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="wcStats" class="stats" style="display:none"></div>
      <div id="wcStatus" class="meta">×”×–×Ÿ ××™×œ×” ×œ×—×™×¤×•×©</div>
      <div id="wcResults" class="results"></div>
    </div>
  </div>

  <!-- Roshei/Sofei Tevot -->
  <div id="rosheiTab" class="tab-content">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××™×œ×” ×œ×—×™×¤×•×©</label>
          <input id="rtWord" type="text" placeholder="×××ª" style="width:120px">
        </div>
        <div>
          <label>××¦×‘</label>
          <select id="rtMode">
            <option value="first">×¨××©×™ ×ª×™×‘×•×ª (××•×ª ×¨××©×•× ×”)</option>
            <option value="last">×¡×•×¤×™ ×ª×™×‘×•×ª (××•×ª ××—×¨×•× ×”)</option>
            <option value="1">××•×ª ×©× ×™×™×”</option>
            <option value="2">××•×ª ×©×œ×™×©×™×ª</option>
          </select>
        </div>
        <div>
          <label>×¡×¤×¨×™×</label>
          <div id="rtBookSelect"></div>
        </div>
        <div style="display:flex;align-items:center;gap:4px;padding-top:18px">
          <input type="checkbox" id="rtReverse"><label for="rtReverse" style="margin:0;cursor:pointer">×¡×“×¨ ×”×¤×•×š</label>
        </div>
        <div><label>&nbsp;</label><button id="rtBtn">×—×¤×©</button></div>
      </div>
      <div id="rtErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="rtStats" class="stats" style="display:none"></div>
      <div id="rtStatus" class="meta">×”×–×Ÿ ××™×œ×” ×œ×—×™×¤×•×©</div>
      <div id="rtResults" class="results"></div>
    </div>
  </div>

  <!-- ELS (Equidistant Letter Sequences) -->
  <div id="elsTab" class="tab-content">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××™×œ×” ×œ×—×™×¤×•×© (2-10 ××•×ª×™×•×ª)</label>
          <input id="elsWord" type="text" placeholder="×ª×•×¨×”" style="width:120px" maxlength="10">
        </div>
        <div>
          <label>×“×™×œ×•×’ ××™× ×™××œ×™</label>
          <input id="elsMin" type="number" value="1" min="1" style="width:80px">
        </div>
        <div>
          <label>×“×™×œ×•×’ ××§×¡×™××œ×™</label>
          <input id="elsMax" type="number" value="100" min="1" style="width:80px">
        </div>
        <div>
          <label>×¡×¤×¨×™×</label>
          <div id="elsBookSelect"></div>
        </div>
        <div style="display:flex;align-items:center;gap:4px;padding-top:18px">
          <input type="checkbox" id="elsReverse"><label for="elsReverse" style="margin:0;cursor:pointer">×¡×“×¨ ×”×¤×•×š</label>
        </div>
        <div><label>&nbsp;</label><button id="elsBtn">×—×¤×©</button></div>
      </div>
      <div class="hint">âš ï¸ ×—×™×¤×•×© ×“×™×œ×•×’×™ ××•×ª×™×•×ª ×©×•×•×™× - ×“×™×œ×•×’×™× ×’×“×•×œ×™× (××¢×œ 500) ×¢×œ×•×œ×™× ×œ×§×—×ª ×–××Ÿ ×¨×‘!</div>
      <div id="elsErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="elsStats" class="stats" style="display:none"></div>
      <div id="elsStatus" class="meta">×”×–×Ÿ ××™×œ×” ×œ×—×™×¤×•×©</div>
      <div id="elsResults" class="results"></div>
    </div>
  </div>

  <!-- Letter Start/End Search -->
  <div id="letterSearchTab" class="tab-content">
    <div class="card no-top">
      <h3 style="margin:0 0 12px;font-size:15px">ğŸ”¤ ×—×™×¤×•×© ×œ×¤×™ ××•×ª ×¤×•×ª×—×ª ×•×¡×•×’×¨×ª</h3>
      <p class="hint" style="margin-bottom:12px">××¦× ×¤×¡×•×§×™× ×©××ª×—×™×œ×™× ×‘××•×ª ××—×ª ×•××¡×ª×™×™××™× ×‘××•×ª ××—×¨×ª. ××•×ª×™×•×ª ×¡×•×¤×™×•×ª (×š × ×Ÿ ×£ ×¥) × ×—×©×‘×•×ª ×›××•×ª×™×•×ª ×¨×’×™×œ×•×ª.</p>
      <div class="row">
        <div>
          <label>××•×ª ×”×ª×—×œ×”</label>
          <select id="lsStart" style="font-size:18px;width:60px">
            <option value="×">×</option><option value="×‘">×‘</option><option value="×’">×’</option>
            <option value="×“">×“</option><option value="×”">×”</option><option value="×•">×•</option>
            <option value="×–">×–</option><option value="×—">×—</option><option value="×˜">×˜</option>
            <option value="×™">×™</option><option value="×›">×›</option><option value="×œ">×œ</option>
            <option value="×">×</option><option value="× ">× </option><option value="×¡">×¡</option>
            <option value="×¢">×¢</option><option value="×¤">×¤</option><option value="×¦">×¦</option>
            <option value="×§">×§</option><option value="×¨">×¨</option><option value="×©">×©</option>
            <option value="×ª">×ª</option>
          </select>
        </div>
        <div>
          <label>××•×ª ×¡×™×•×</label>
          <select id="lsEnd" style="font-size:18px;width:60px">
            <option value="×">×</option><option value="×‘">×‘</option><option value="×’">×’</option>
            <option value="×“">×“</option><option value="×”">×”</option><option value="×•">×•</option>
            <option value="×–">×–</option><option value="×—">×—</option><option value="×˜">×˜</option>
            <option value="×™">×™</option><option value="×›">×›</option><option value="×œ">×œ</option>
            <option value="×">×</option><option value="× ">× </option><option value="×¡">×¡</option>
            <option value="×¢">×¢</option><option value="×¤">×¤</option><option value="×¦">×¦</option>
            <option value="×§">×§</option><option value="×¨">×¨</option><option value="×©">×©</option>
            <option value="×ª" selected>×ª</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;gap:4px;padding-top:18px">
          <input type="checkbox" id="lsReverse"><label for="lsReverse" style="margin:0;cursor:pointer">×¡×“×¨ ×”×¤×•×š</label>
        </div>
        <div><label>&nbsp;</label><button id="lsBtn">×—×¤×©</button></div>
      </div>
      <div id="lsErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="lsStats" class="stats" style="display:none"></div>
      <div id="lsStatus" class="meta">×‘×—×¨ ××•×ª ×”×ª×—×œ×” ×•××•×ª ×¡×™×•×</div>
      <div id="lsResults" class="results"></div>
    </div>
  </div>

  <!-- Kabbalah Terms Search -->
  <div id="kabbalahTab" class="tab-content">
    <div class="card no-top">
      <h3 style="margin:0 0 12px;font-size:15px">âœ¡ï¸ ×—×™×¤×•×© ××•×©×’×™ ×§×‘×œ×” ×‘×ª× ×´×š</h3>
      <p class="hint" style="margin-bottom:12px">×—×¤×© ××•× ×—×™× ×§×‘×œ×™×™× ×›××• ×”×¡×¤×™×¨×•×ª, ×©××•×ª ×”×§×•×“×© ×•××•×©×’×™× ××¨×›×–×™×™×.</p>
      <div class="row">
        <div>
          <label>×§×˜×’×•×¨×™×”</label>
          <select id="kbCategory">
            <option value="sefirot">×¡×¤×™×¨×•×ª (10 ×¡×¤×™×¨×•×ª)</option>
            <option value="names">×©××•×ª ×”×§×•×“×©</option>
            <option value="concepts">××•×©×’×™× ×¨×•×—× ×™×™×</option>
            <option value="">×”×›×•×œ</option>
          </select>
        </div>
        <div>
          <label>××• ××•× ×— ×¡×¤×¦×™×¤×™</label>
          <input id="kbTerm" type="text" placeholder="×›×ª×¨, ×—×›××”..." style="width:120px">
        </div>
        <div><label>&nbsp;</label><button id="kbBtn">×—×¤×©</button></div>
      </div>
      <div id="kbErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="kbTermsList" style="margin-bottom:12px">
        <h4 style="margin:0 0 8px;font-size:13px">ğŸ“‹ ×œ×—×¥ ×¢×œ ××•× ×— ×œ×—×™×¤×•×© ××”×™×¨:</h4>
        <div id="kbQuickTerms" class="top-chips"></div>
      </div>
      <div id="kbStats" class="stats" style="display:none"></div>
      <div id="kbStatus" class="meta">×‘×—×¨ ×§×˜×’×•×¨×™×” ××• ×”×–×Ÿ ××•× ×—</div>
      <div id="kbResults" class="results"></div>
    </div>
  </div>

  <!-- Text Search -->
  <div id="textSearchTab" class="tab-content">
    <div class="card no-top">
      <h3 style="margin:0 0 12px;font-size:15px">ğŸ” ×—×™×¤×•×© ××™×œ×” ××• ××©×¤×˜ ×‘×ª× ×´×š</h3>
      <p class="hint" style="margin-bottom:12px">×—×¤×© ××™×œ×™× ××• ×‘×™×˜×•×™×™× ×‘×˜×§×¡×˜ ×”×ª× ×´×š. ×ª×•××š ×‘×”×ª×××•×ª ×—×œ×§×™×•×ª (××™×œ×” ×‘×ª×•×š ××™×œ×”, ×‘×™×˜×•×™ ×‘×ª×•×š ×¤×¡×•×§).</p>
      <div class="row">
        <div>
          <label>×˜×§×¡×˜ ×œ×—×™×¤×•×©</label>
          <input id="tsQuery" type="text" placeholder="×‘×¨××©×™×ª" style="width:200px">
        </div>
        <div>
          <label>×¡×¤×¨×™×</label>
          <div id="tsBookSelect"></div>
        </div>
        <div><label>&nbsp;</label><button id="tsBtn">×—×¤×©</button></div>
      </div>
      <div id="tsErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="tsStats" class="stats" style="display:none"></div>
      <div id="tsStatus" class="meta">×”×–×Ÿ ×˜×§×¡×˜ ×œ×—×™×¤×•×©</div>
      <div id="tsResults" class="results"></div>
    </div>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle"></h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
let vData=[],wData=[],vLoaded=false,wLoaded=false;

// Book groups definition
const BOOK_GROUPS={
  '×ª×•×¨×”':[
    {value:'Genesis',label:'×‘×¨××©×™×ª'},
    {value:'Exodus',label:'×©××•×ª'},
    {value:'Leviticus',label:'×•×™×§×¨×'},
    {value:'Numbers',label:'×‘××“×‘×¨'},
    {value:'Deuteronomy',label:'×“×‘×¨×™×'}
  ],
  '× ×‘×™××™× ×¨××©×•× ×™×':[
    {value:'Joshua',label:'×™×”×•×©×¢'},
    {value:'Judges',label:'×©×•×¤×˜×™×'},
    {value:'1 Samuel',label:'×©××•××œ ×'},
    {value:'2 Samuel',label:'×©××•××œ ×‘'},
    {value:'1 Kings',label:'××œ×›×™× ×'},
    {value:'2 Kings',label:'××œ×›×™× ×‘'}
  ],
  '× ×‘×™××™× ××—×¨×•× ×™×':[
    {value:'Isaiah',label:'×™×©×¢×™×”×•'},
    {value:'Jeremiah',label:'×™×¨××™×”×•'},
    {value:'Ezekiel',label:'×™×—×–×§××œ'},
    {value:'Hosea',label:'×”×•×©×¢'},
    {value:'Joel',label:'×™×•××œ'},
    {value:'Amos',label:'×¢××•×¡'},
    {value:'Obadiah',label:'×¢×•×‘×“×™×”'},
    {value:'Jonah',label:'×™×•× ×”'},
    {value:'Micah',label:'××™×›×”'},
    {value:'Nahum',label:'× ×—×•×'},
    {value:'Habakkuk',label:'×—×‘×§×•×§'},
    {value:'Zephaniah',label:'×¦×¤× ×™×”'},
    {value:'Haggai',label:'×—×’×™'},
    {value:'Zechariah',label:'×–×›×¨×™×”'},
    {value:'Malachi',label:'××œ××›×™'}
  ],
  '×›×ª×•×‘×™×':[
    {value:'Psalms',label:'×ª×”×™×œ×™×'},
    {value:'Proverbs',label:'××©×œ×™'},
    {value:'Job',label:'××™×•×‘'},
    {value:'Song of Songs',label:'×©×™×¨ ×”×©×™×¨×™×'},
    {value:'Ruth',label:'×¨×•×ª'},
    {value:'Lamentations',label:'××™×›×”'},
    {value:'Ecclesiastes',label:'×§×”×œ×ª'},
    {value:'Esther',label:'××¡×ª×¨'},
    {value:'Daniel',label:'×“× ×™××œ'},
    {value:'Ezra',label:'×¢×–×¨×'},
    {value:'Nehemiah',label:'× ×—××™×”'},
    {value:'1 Chronicles',label:'×“×‘×¨×™ ×”×™××™× ×'},
    {value:'2 Chronicles',label:'×“×‘×¨×™ ×”×™××™× ×‘'}
  ]
};

// Create multi-select book selector
function createBookSelector(id){
  const container=document.getElementById(id);
  if(!container){
    console.error('Container not found:',id);
    return null;
  }

  const state={selected:new Set()};

  const btn=document.createElement('button');
  btn.type='button';
  btn.className='book-select-btn';
  btn.innerHTML='<span>×›×œ ×”×¡×¤×¨×™×</span><span>â–¼</span>';

  const dropdown=document.createElement('div');
  dropdown.className='book-select-dropdown';

  // "All" checkbox
  const allItem=document.createElement('div');
  allItem.className='book-select-item all';
  const allCheckbox=document.createElement('input');
  allCheckbox.type='checkbox';
  allCheckbox.id=id+'-all';
  allCheckbox.checked=true;
  const allLabel=document.createElement('label');
  allLabel.htmlFor=id+'-all';
  allLabel.textContent='×›×œ ×”×¡×¤×¨×™×';
  allItem.appendChild(allCheckbox);
  allItem.appendChild(allLabel);
  dropdown.appendChild(allItem);

  // Group and book checkboxes
  Object.entries(BOOK_GROUPS).forEach(([groupName,books])=>{
    const groupItem=document.createElement('div');
    groupItem.className='book-select-item group';
    const groupCheckbox=document.createElement('input');
    groupCheckbox.type='checkbox';
    groupCheckbox.id=`${id}-group-${groupName}`;
    groupCheckbox.checked=true;
    const groupLabel=document.createElement('label');
    groupLabel.htmlFor=`${id}-group-${groupName}`;
    groupLabel.textContent=groupName;
    groupItem.appendChild(groupCheckbox);
    groupItem.appendChild(groupLabel);
    dropdown.appendChild(groupItem);

    books.forEach(book=>{
      const bookItem=document.createElement('div');
      bookItem.className='book-select-item book';
      const bookCheckbox=document.createElement('input');
      bookCheckbox.type='checkbox';
      bookCheckbox.id=`${id}-book-${book.value}`;
      bookCheckbox.checked=true;
      bookCheckbox.dataset.group=groupName;
      bookCheckbox.value=book.value;
      const bookLabel=document.createElement('label');
      bookLabel.htmlFor=`${id}-book-${book.value}`;
      bookLabel.textContent=book.label;
      bookItem.appendChild(bookCheckbox);
      bookItem.appendChild(bookLabel);
      dropdown.appendChild(bookItem);
    });
  });

  container.innerHTML='';
  container.appendChild(btn);
  container.appendChild(dropdown);
  container.className='book-select';

  // Toggle dropdown
  btn.onclick=e=>{
    e.stopPropagation();
    dropdown.classList.toggle('open');
  };

  // Close dropdown when clicking outside
  document.addEventListener('click',e=>{
    if(!container.contains(e.target)){
      dropdown.classList.remove('open');
    }
  });

  // Handle checkbox changes
  dropdown.addEventListener('change',e=>{
    const target=e.target;
    if(!target.matches('input[type="checkbox"]'))return;

    const allCheckbox=dropdown.querySelector('#'+id+'-all');

    if(target.id===id+'-all'){
      // Toggle all
      const checked=target.checked;
      dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=checked);
      if(checked){
        state.selected.clear();
      }else{
        Object.values(BOOK_GROUPS).flat().forEach(b=>state.selected.add(b.value));
      }
    }else if(target.id.startsWith(id+'-group-')){
      // Toggle group
      const groupName=target.id.replace(id+'-group-','');
      const checked=target.checked;
      dropdown.querySelectorAll(`input[data-group="${groupName}"]`).forEach(cb=>cb.checked=checked);
      updateAllCheckbox();
    }else{
      // Toggle individual book
      updateGroupCheckbox(target.dataset.group);
      updateAllCheckbox();
    }

    updateButtonText();
  });

  function updateGroupCheckbox(groupName){
    const groupCheckbox=dropdown.querySelector(`#${id}-group-${groupName}`);
    const bookCheckboxes=dropdown.querySelectorAll(`input[data-group="${groupName}"]`);
    const allChecked=Array.from(bookCheckboxes).every(cb=>cb.checked);
    const someChecked=Array.from(bookCheckboxes).some(cb=>cb.checked);
    groupCheckbox.checked=allChecked;
    groupCheckbox.indeterminate=someChecked&&!allChecked;
  }

  function updateAllCheckbox(){
    const allCheckbox=dropdown.querySelector('#'+id+'-all');
    const allBookCheckboxes=dropdown.querySelectorAll('input[type="checkbox"][value]');
    const allChecked=Array.from(allBookCheckboxes).every(cb=>cb.checked);
    const someChecked=Array.from(allBookCheckboxes).some(cb=>cb.checked);
    allCheckbox.checked=allChecked;
    allCheckbox.indeterminate=someChecked&&!allChecked;
  }

  function updateButtonText(){
    const bookCheckboxes=dropdown.querySelectorAll('input[type="checkbox"][value]');
    const checkedCount=Array.from(bookCheckboxes).filter(cb=>cb.checked).length;
    const totalCount=bookCheckboxes.length;

    if(checkedCount===0){
      btn.querySelector('span').textContent='×œ× × ×‘×—×¨×• ×¡×¤×¨×™×';
    }else if(checkedCount===totalCount){
      btn.querySelector('span').textContent='×›×œ ×”×¡×¤×¨×™×';
    }else{
      btn.querySelector('span').textContent=`${checkedCount} ×¡×¤×¨×™×`;
    }
  }

  // Get selected books
  state.getSelected=()=>{
    const allCheckbox=dropdown.querySelector('#'+id+'-all');
    if(allCheckbox.checked&&!allCheckbox.indeterminate){
      return[];// Empty array means all books
    }
    const bookCheckboxes=dropdown.querySelectorAll('input[type="checkbox"][value]:checked');
    return Array.from(bookCheckboxes).map(cb=>cb.value);
  };

  return state;
}

// Book selector states
let bookSelector,wcBookSelector,rtBookSelector,elsBookSelector,tsBookSelector;

// Search
function syncMode(){
  $("numWrap").style.display=$("mode").value==="number"?"block":"none";
  $("txtWrap").style.display=$("mode").value==="text"?"block":"none";
}
$("mode").onchange=syncMode;

async function doSearch(){
  const mode=$("mode").value,kind=$("kind").value;
  const selectedBooks=bookSelector?bookSelector.getSelected():[];
  const params=new URLSearchParams();
  if(kind)params.set("kind",kind);
  selectedBooks.forEach(b=>params.append("books",b));
  params.set("limit","500");

  if(mode==="number"){
    const v=$("value").value.trim();
    if(!v){$("err").textContent="×”×–×Ÿ ××¡×¤×¨";$("err").style.display="block";return;}
    params.set("value",v);
  }else{
    const t=$("text").value.trim();
    if(!t){$("err").textContent="×”×–×Ÿ ×˜×§×¡×˜";$("err").style.display="block";return;}
    try{
      const g=await(await fetch("/gematria?text="+encodeURIComponent(t))).json();
      $("calc").textContent="×’×™××˜×¨×™×”: "+g.gematria;$("calc").style.display="block";
    }catch(e){$("err").textContent=e.message;$("err").style.display="block";return;}
    params.set("text",t);
  }

  $("btn").disabled=true;$("status").textContent="××—×¤×©...";$("results").innerHTML="";$("err").style.display="none";
  const kindHeb={verse:'×¤×¡×•×§',word:'××™×œ×”',gram:'×¦×™×¨×•×£'};
  try{
    const data=await(await fetch("/search?"+params)).json();
    $("status").textContent="× ××¦××• "+data.length+" ×ª×•×¦××•×ª";
    $("results").innerHTML=data.map(h=>`<div class="hit"><div><span class="ref">${h.ref}</span><span class="pill">${kindHeb[h.kind]||h.kind}</span><span class="meta" style="float:left">×’×™××˜×¨×™×”: ${h.gematria}</span></div><div class="text">${h.text}</div>${h.match_text?`<div class="meta">×”×ª×××”: ${h.match_text}</div>`:''}</div>`).join('');
  }catch(e){$("err").textContent=e.message;$("err").style.display="block";}
  $("btn").disabled=false;
}
$("btn").onclick=doSearch;
$("value").onkeydown=e=>{if(e.key==="Enter")doSearch();};
$("text").onkeydown=e=>{if(e.key==="Enter")doSearch();};
syncMode();

// Tabs
function activateTab(tabName){
  const tab=document.querySelector(`.tab[data-tab="${tabName}"]`);
  if(!tab)return;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  tab.classList.add('active');
  $(tabName+'Tab').classList.add('active');
  if(tabName==='histogram'&&!vLoaded)loadData('verses');
  if(tabName==='histogramWords'&&!wLoaded)loadData('words');
}
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    const tabName=tab.dataset.tab;
    history.pushState(null,null,'#'+tabName);
    activateTab(tabName);
  };
});
// Handle URL hash on load and back/forward
function handleHash(){
  const hash=location.hash.slice(1)||'search';
  activateTab(hash);
}
window.addEventListener('hashchange',handleHash);
handleHash();

// Load histogram data
async function loadData(type){
  const isV=type==='verses';
  const loading=$(isV?'vLoading':'wLoading');
  const statsDiv=$(isV?'vStats':'wStats');
  const overviewDiv=$(isV?'vOverview':'wOverview');
  const topDiv=$(isV?'vTopSection':'wTopSection');

  try{
    const data=await(await fetch(isV?'/histogram':'/histogram/words')).json();
    if(isV){vData=data;vLoaded=true;}else{wData=data;wLoaded=true;}

    const total=data.reduce((s,b)=>s+b.count,0);
    const minG=data[0]?.gematria||0;
    const maxG=data[data.length-1]?.gematria||0;

    // Find top 10 by count
    const sorted=[...data].sort((a,b)=>b.count-a.count);
    const top10=sorted.slice(0,10);

    statsDiv.innerHTML=`
      <div class="stat"><b>${total.toLocaleString()}</b><span>${isV?'×¤×¡×•×§×™×':'××™×œ×™×'}</span></div>
      <div class="stat"><b>${data.length.toLocaleString()}</b><span>×¢×¨×›×™×</span></div>
      <div class="stat"><b>${minG}-${maxG}</b><span>×˜×•×•×—</span></div>
    `;

    // Render top values
    topDiv.innerHTML=`
      <h4>ğŸ† ×¢×¨×›×™ ×”×©×™× (×”×›×™ × ×¤×•×¦×™×)</h4>
      <div class="top-chips">
        ${top10.map((d,i)=>`<div class="top-chip" onclick="showModal('${type}',${d.gematria})">${i+1}. ×’×™××˜×¨×™×” ${d.gematria}<b>${d.count}</b></div>`).join('')}
      </div>
    `;

    // Create overview buckets (group into ~40 buckets)
    const bucketSize=Math.ceil((maxG-minG+1)/40);
    const buckets=[];
    for(let i=minG;i<=maxG;i+=bucketSize){
      const end=Math.min(i+bucketSize-1,maxG);
      const items=data.filter(d=>d.gematria>=i&&d.gematria<=end);
      const count=items.reduce((s,d)=>s+d.count,0);
      buckets.push({min:i,max:end,count,items});
    }

    renderOverview(type,buckets,overviewDiv);
    loading.style.display='none';
  }catch(e){
    loading.innerHTML=`<div class="error">×©×’×™××”: ${e.message}</div>`;
  }
}

function renderOverview(type,buckets,container){
  const maxCount=Math.max(...buckets.map(b=>b.count));
  const h=100;

  container.innerHTML=buckets.map((b,i)=>{
    const bh=Math.max(4,b.count/maxCount*h);
    return `<div class="bar" style="height:${bh}px;flex:1;min-width:16px" onclick="showDetail('${type}',${i})" data-idx="${i}">
      <span class="bar-label">${b.min}-${b.max}</span>
      ${b.count>0?`<span class="bar-count">${b.count>999?(b.count/1000).toFixed(1)+'k':b.count}</span>`:''}
    </div>`;
  }).join('');

  // Store buckets for later
  if(type==='verses')window.vBuckets=buckets;
  else window.wBuckets=buckets;
}

function showDetail(type,bucketIdx){
  const isV=type==='verses';
  const buckets=isV?window.vBuckets:window.wBuckets;
  const bucket=buckets[bucketIdx];
  const section=$(isV?'vDetailSection':'wDetailSection');
  const title=$(isV?'vDetailTitle':'wDetailTitle');
  const container=$(isV?'vDetail':'wDetail');
  const data=isV?vData:wData;

  // Get items in this range
  const items=data.filter(d=>d.gematria>=bucket.min&&d.gematria<=bucket.max);

  if(!items.length){
    container.innerHTML='<div class="no-data">××™×Ÿ × ×ª×•× ×™×</div>';
    section.style.display='block';
    return;
  }

  const maxCount=Math.max(...items.map(d=>d.count));
  const h=150;
  const barW=Math.max(20,Math.min(50,Math.floor((container.clientWidth||600)/items.length)-4));

  container.innerHTML=items.map((d,i)=>{
    const bh=Math.max(4,d.count/maxCount*h);
    return `<div class="bar" style="height:${bh}px;width:${barW}px" onclick="showModal('${type}',${d.gematria})">
      <span class="bar-label">${d.gematria}</span>
      <span class="bar-count">${d.count}</span>
    </div>`;
  }).join('');

  title.textContent=`×˜×•×•×— ${bucket.min}-${bucket.max} (${items.length} ×¢×¨×›×™×)`;
  section.style.display='block';
  section.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function hideDetail(type){
  $(type==='verses'?'vDetailSection':'wDetailSection').style.display='none';
}

function jumpTo(type){
  const isV=type==='verses';
  const target=parseInt($(isV?'vJump':'wJump').value)||0;
  const buckets=isV?window.vBuckets:window.wBuckets;
  if(!buckets)return;

  // Find bucket containing target
  const idx=buckets.findIndex(b=>target>=b.min&&target<=b.max);
  if(idx>=0){
    showDetail(type,idx);
    // After detail renders, show modal for exact value
    setTimeout(()=>showModal(type,target),200);
  }
}

// Modal
function showModal(type,gematria){
  const data=type==='verses'?vData:wData;
  const bucket=data.find(d=>d.gematria===gematria);
  if(!bucket)return;

  const isV=type==='verses';
  const items=isV?bucket.verses:bucket.words;
  const label=isV?'×¤×¡×•×§×™×':'××™×œ×™×';

  $('modalTitle').textContent=`×’×™××˜×¨×™×” ${gematria} (${bucket.count} ${label})`;
  $('modalBody').innerHTML=items.slice(0,100).map(item=>{
    if(isV){
      return `<div class="modal-item" onclick="searchGem(${gematria},'verse')">
        <div class="modal-ref">${item.ref}</div>
        <div class="modal-text">${item.text}</div>
      </div>`;
    }else{
      return `<div class="modal-item" onclick="searchGem(${gematria},'word')">
        <div class="modal-ref">${item.ref}<span class="modal-word">${item.word}</span></div>
        <div class="modal-text">${item.verse_text}</div>
      </div>`;
    }
  }).join('')+(items.length>100?`<div class="meta" style="text-align:center;padding:10px">××¦×™×’ 100 ××ª×•×š ${items.length}</div>`:'');

  $('modal').classList.add('visible');
}

function closeModal(){$('modal').classList.remove('visible');}
function searchGem(g,k){
  closeModal();
  document.querySelectorAll('.tab')[0].click();
  $('mode').value='number';syncMode();
  $('value').value=g;$('kind').value=k;
  doSearch();
}

$('modal').onclick=e=>{if(e.target.id==='modal')closeModal();};
document.onkeydown=e=>{if(e.key==='Escape')closeModal();};

// Word Count Search
async function doWordSearch(){
  const word=$('wcWord').value.trim();
  const selectedBooks=wcBookSelector?wcBookSelector.getSelected():[];
  if(!word){$('wcErr').textContent='×”×–×Ÿ ××™×œ×”';$('wcErr').style.display='block';return;}

  $('wcBtn').disabled=true;$('wcStatus').textContent='××—×¤×©...';$('wcResults').innerHTML='';$('wcErr').style.display='none';$('wcStats').style.display='none';

  try{
    const params=new URLSearchParams({word});
    selectedBooks.forEach(b=>params.append('books',b));
    const data=await(await fetch('/word-search?'+params)).json();

    // Check for API error
    if(data.detail){
      $('wcErr').textContent=data.detail;$('wcErr').style.display='block';
      $('wcBtn').disabled=false;
      return;
    }

    $('wcStats').innerHTML=`
      <div class="stat"><b>${data.count.toLocaleString()}</b><span>××•×¤×¢×™× ×‘×ª× ×´×š</span></div>
      <div class="stat"><b>${data.word}</b><span>××™×œ×” (×œ×œ× × ×™×§×•×“)</span></div>
    `;
    $('wcStats').style.display='flex';

    if(data.count===0){
      $('wcStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      $('wcStatus').textContent=`× ××¦××• ${data.count.toLocaleString()} ××•×¤×¢×™×`;
      $('wcResults').innerHTML=data.locations.map(loc=>{
        // Highlight all occurrences of word_text in verse
        const escaped=loc.word_text.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        const highlighted=loc.verse_text.replace(new RegExp(escaped,'g'),`<mark>${loc.word_text}</mark>`);
        return `<div class="hit">
          <div><span class="ref">${loc.ref}</span><span class="pill">${loc.word_text}</span></div>
          <div class="text">${highlighted}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    $('wcErr').textContent=e.message;$('wcErr').style.display='block';
  }
  $('wcBtn').disabled=false;
}
$('wcBtn').onclick=doWordSearch;
$('wcWord').onkeydown=e=>{if(e.key==='Enter')doWordSearch();};

// Roshei/Sofei Tevot Search
async function doRosheiSearch(){
  const word=$('rtWord').value.trim();
  if(!word){$('rtErr').textContent='×”×–×Ÿ ××™×œ×”';$('rtErr').style.display='block';return;}

  const mode=$('rtMode').value;
  const selectedBooks=rtBookSelector?rtBookSelector.getSelected():[];
  $('rtBtn').disabled=true;$('rtStatus').textContent='××—×¤×©...';$('rtResults').innerHTML='';$('rtErr').style.display='none';$('rtStats').style.display='none';

  try{
    const params=new URLSearchParams({word,mode});
    selectedBooks.forEach(b=>params.append('books',b));
    if($('rtReverse').checked)params.set('reverse','true');
    const data=await(await fetch(`/roshei-tevot?${params}`)).json();

    // Check for API error
    if(data.detail){
      $('rtErr').textContent=data.detail;$('rtErr').style.display='block';
      $('rtBtn').disabled=false;
      return;
    }

    $('rtStats').innerHTML=`
      <div class="stat"><b>${data.count.toLocaleString()}</b><span>×ª×•×¦××•×ª</span></div>
      <div class="stat"><b>${data.mode}</b><span>××¦×‘ ×—×™×¤×•×©</span></div>
    `;
    $('rtStats').style.display='flex';

    if(data.count===0){
      $('rtStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      $('rtStatus').textContent=`× ××¦××• ${data.count.toLocaleString()} ×ª×•×¦××•×ª`;
      $('rtResults').innerHTML=data.matches.map(m=>{
        const wordsHtml=m.words.map((w,i)=>`<mark>${w}</mark>`).join(' ');
        return `<div class="hit">
          <div><span class="ref">${m.ref}</span><span class="pill">${m.letters}</span></div>
          <div class="text">${m.verse_text}</div>
          <div class="meta">××™×œ×™×: ${wordsHtml}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    $('rtErr').textContent=e.message||'×©×’×™××”';$('rtErr').style.display='block';
  }
  $('rtBtn').disabled=false;
}
$('rtBtn').onclick=doRosheiSearch;
$('rtWord').onkeydown=e=>{if(e.key==='Enter')doRosheiSearch();};

// ELS Search
function highlightElsText(text,positions){
  // Insert highlights at letter positions (from end to start to preserve indices)
  let chars=[...text];
  const posSet=new Set(positions);
  let result='';
  for(let i=0;i<chars.length;i++){
    if(posSet.has(i)){
      result+=`<span class="els-letter">${chars[i]}</span>`;
    }else{
      result+=chars[i];
    }
  }
  return result;
}

async function doElsSearch(){
  const word=$('elsWord').value.trim();
  if(!word||word.length<2){$('elsErr').textContent='×”×–×Ÿ ×œ×¤×—×•×ª 2 ××•×ª×™×•×ª';$('elsErr').style.display='block';return;}

  const minSkip=parseInt($('elsMin').value)||1;
  const maxSkip=parseInt($('elsMax').value)||100;
  const selectedBooks=elsBookSelector?elsBookSelector.getSelected():[];

  if(minSkip>maxSkip){$('elsErr').textContent='×“×™×œ×•×’ ××™× ×™××œ×™ ×—×™×™×‘ ×œ×”×™×•×ª ×§×˜×Ÿ ××• ×©×•×•×” ×œ×“×™×œ×•×’ ××§×¡×™××œ×™';$('elsErr').style.display='block';return;}
  if(maxSkip>500&&!confirm('×“×™×œ×•×’ ××¢×œ 500 ×¢×œ×•×œ ×œ×§×—×ª ×–××Ÿ ×¨×‘. ×œ×”××©×™×š?'))return;

  $('elsBtn').disabled=true;$('elsStatus').textContent='××—×¤×©... (×¢×©×•×™ ×œ×§×—×ª ×–××Ÿ)';$('elsResults').innerHTML='';$('elsErr').style.display='none';$('elsStats').style.display='none';

  try{
    const params=new URLSearchParams({word,min_skip:minSkip,max_skip:maxSkip});
    selectedBooks.forEach(b=>params.append('books',b));
    if($('elsReverse').checked)params.set('reverse','true');
    const resp=await fetch(`/els?${params}`);
    const data=await resp.json();

    // Check for API error
    if(data.detail){
      $('elsErr').textContent=data.detail;$('elsErr').style.display='block';
      $('elsBtn').disabled=false;
      return;
    }

    $('elsStats').innerHTML=`
      <div class="stat"><b>${(data.count||0).toLocaleString()}</b><span>×ª×•×¦××•×ª</span></div>
      <div class="stat"><b>${data.search_word||''}</b><span>××™×œ×”</span></div>
    `;
    $('elsStats').style.display='flex';

    if(!data.count||data.count===0){
      $('elsStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      $('elsStatus').textContent=`× ××¦××• ${data.count.toLocaleString()} ×ª×•×¦××•×ª`;
      $('elsResults').innerHTML=data.matches.map((m,idx)=>{
        const highlighted=highlightElsText(m.full_text||'',m.letter_positions||[]);
        return `<div class="hit">
          <div>
            <span class="ref">${m.ref_start}</span>
            <span class="pill">×“×™×œ×•×’: ${m.skip}</span>
            <span class="pill">${m.matched_letters}</span>
            <span class="expand-btn expandable" onclick="this.parentElement.parentElement.querySelector('.expandable-content').classList.toggle('open')">â–¼ ×”×¦×’ ×˜×§×¡×˜ ××œ×</span>
          </div>
          <div class="meta">×: ${m.ref_start} ×¢×“: ${m.ref_end}</div>
          <div class="expandable-content" dir="rtl">${highlighted}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    console.error('ELS error:',e);
    $('elsErr').textContent=e.message||'×©×’×™××” ×‘×—×™×¤×•×©';$('elsErr').style.display='block';
  }
  $('elsBtn').disabled=false;
}
$('elsBtn').onclick=doElsSearch;
$('elsWord').onkeydown=e=>{if(e.key==='Enter')doElsSearch();};

// Letter Start/End Search
async function doLetterSearch(){
  const start=$('lsStart').value;
  const end=$('lsEnd').value;

  $('lsBtn').disabled=true;$('lsStatus').textContent='××—×¤×©...';$('lsResults').innerHTML='';$('lsErr').style.display='none';$('lsStats').style.display='none';

  try{
    const params=new URLSearchParams({start,end});
    if($('lsReverse').checked)params.set('reverse','true');
    const data=await(await fetch(`/letter-search?${params}`)).json();

    $('lsStats').innerHTML=`
      <div class="stat"><b>${data.count.toLocaleString()}</b><span>×¤×¡×•×§×™×</span></div>
      <div class="stat"><b>${data.start_letter} â†’ ${data.end_letter}</b><span>××•×ª ×”×ª×—×œ×” â†’ ×¡×™×•×</span></div>
    `;
    $('lsStats').style.display='flex';

    if(data.count===0){
      $('lsStatus').textContent='×œ× × ××¦××• ×¤×¡×•×§×™×';
    }else{
      $('lsStatus').textContent=`× ××¦××• ${data.count.toLocaleString()} ×¤×¡×•×§×™× ×©××ª×—×™×œ×™× ×‘-${data.start_letter} ×•××¡×ª×™×™××™× ×‘-${data.end_letter}`;
      $('lsResults').innerHTML=data.matches.map(m=>{
        // Highlight first and last letters
        const words=m.verse_text.split(' ');
        if(words.length>0){
          const first=words[0];
          const last=words[words.length-1];
          words[0]=`<mark>${first}</mark>`;
          if(words.length>1)words[words.length-1]=`<mark>${last}</mark>`;
        }
        return `<div class="hit">
          <div><span class="ref">${m.ref}</span><span class="pill">${m.first_letter}...${m.last_letter}</span></div>
          <div class="text">${words.join(' ')}</div>
          <div class="meta">××™×œ×” ×¨××©×•× ×”: <b>${m.first_word}</b> | ××™×œ×” ××—×¨×•× ×”: <b>${m.last_word}</b></div>
        </div>`;
      }).join('');
    }
  }catch(e){
    $('lsErr').textContent=e.message||'×©×’×™××”';$('lsErr').style.display='block';
  }
  $('lsBtn').disabled=false;
}
$('lsBtn').onclick=doLetterSearch;

// Kabbalah Terms Search
const sefirotTerms=['×›×ª×¨','×—×›××”','×‘×™× ×”','×“×¢×ª','×—×¡×“','×’×‘×•×¨×”','×ª×¤××¨×ª','× ×¦×—','×”×•×“','×™×¡×•×“','××œ×›×•×ª'];
const kbQuickTermsHtml=sefirotTerms.map(t=>`<div class="top-chip" onclick="searchKabbalahTerm('${t}')">${t}</div>`).join('');
$('kbQuickTerms').innerHTML=kbQuickTermsHtml;

function searchKabbalahTerm(term){
  $('kbTerm').value=term;
  $('kbCategory').value='';
  doKabbalahSearch();
}

async function doKabbalahSearch(){
  const category=$('kbCategory').value;
  const term=$('kbTerm').value.trim();

  if(!category&&!term){
    $('kbErr').textContent='×‘×—×¨ ×§×˜×’×•×¨×™×” ××• ×”×–×Ÿ ××•× ×—';$('kbErr').style.display='block';return;
  }

  $('kbBtn').disabled=true;$('kbStatus').textContent='××—×¤×©...';$('kbResults').innerHTML='';$('kbErr').style.display='none';$('kbStats').style.display='none';

  try{
    let url='/kabbalah-search?';
    if(term)url+=`term=${encodeURIComponent(term)}`;
    else if(category)url+=`category=${category}`;

    const data=await(await fetch(url)).json();

    const totalCount=data.reduce((s,t)=>s+t.count,0);
    $('kbStats').innerHTML=`
      <div class="stat"><b>${totalCount.toLocaleString()}</b><span>××•×¤×¢×™×</span></div>
      <div class="stat"><b>${data.length}</b><span>××•× ×—×™×</span></div>
    `;
    $('kbStats').style.display='flex';

    if(totalCount===0){
      $('kbStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      $('kbStatus').textContent=`× ××¦××• ${totalCount.toLocaleString()} ××•×¤×¢×™× ×‘-${data.length} ××•× ×—×™×`;
      $('kbResults').innerHTML=data.map(termData=>{
        const locationsHtml=termData.locations.slice(0,20).map(loc=>{
          const escaped=loc.word_text.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
          const highlighted=loc.verse_text.replace(new RegExp(escaped,'g'),`<mark>${loc.word_text}</mark>`);
          return `<div style="padding:6px 0;border-bottom:1px solid #eee">
            <span class="ref" style="font-size:12px">${loc.ref}</span>
            <div class="text" style="font-size:13px">${highlighted}</div>
          </div>`;
        }).join('');
        const moreText=termData.count>20?`<div class="hint">...×•×¢×•×“ ${termData.count-20} ××•×¤×¢×™×</div>`:'';
        return `<div class="hit">
          <div style="cursor:pointer" onclick="this.parentElement.querySelector('.expandable-content').classList.toggle('open')">
            <span class="ref" style="font-size:16px">${termData.term}</span>
            <span class="pill" style="font-size:12px">${termData.name}</span>
            <span class="pill">${termData.count} ××•×¤×¢×™×</span>
            <span class="expand-btn">â–¼</span>
          </div>
          <div class="expandable-content">${locationsHtml}${moreText}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    $('kbErr').textContent=e.message||'×©×’×™××”';$('kbErr').style.display='block';
  }
  $('kbBtn').disabled=false;
}
$('kbBtn').onclick=doKabbalahSearch;
$('kbTerm').onkeydown=e=>{if(e.key==='Enter')doKabbalahSearch();};

// Text Search
async function doTextSearch(){
  const query=$('tsQuery').value.trim();
  if(!query){$('tsErr').textContent='×”×–×Ÿ ×˜×§×¡×˜ ×œ×—×™×¤×•×©';$('tsErr').style.display='block';return;}

  const selectedBooks=tsBookSelector?tsBookSelector.getSelected():[];
  $('tsBtn').disabled=true;$('tsStatus').textContent='××—×¤×©...';$('tsResults').innerHTML='';$('tsErr').style.display='none';$('tsStats').style.display='none';

  try{
    const params=new URLSearchParams({q:query,limit:'500'});
    selectedBooks.forEach(b=>params.append('books',b));
    const resp=await fetch(`/text-search?${params}`);
    const data=await resp.json();

    // Check for API error
    if(data.detail){
      $('tsErr').textContent=data.detail;$('tsErr').style.display='block';
      $('tsBtn').disabled=false;
      return;
    }

    $('tsStats').innerHTML=`
      <div class="stat"><b>${data.count.toLocaleString()}</b><span>×¤×¡×•×§×™× ××ª××™××™×</span></div>
      <div class="stat"><b>${data.query}</b><span>×—×™×¤×•×© (×× ×•×¨××œ)</span></div>
    `;
    $('tsStats').style.display='flex';

    if(data.count===0){
      $('tsStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      const showing=data.hits.length;
      $('tsStatus').textContent=`××¦×™×’ ${showing.toLocaleString()} ××ª×•×š ${data.count.toLocaleString()} ×ª×•×¦××•×ª`;
      $('tsResults').innerHTML=data.hits.map(hit=>{
        // Highlight matched text in verse
        // We need to highlight in the clean_text context but show in original text
        // For simplicity, try to find and highlight the query in the original text
        const escaped=data.query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        // Create a pattern that matches the query with possible nikud/marks between letters
        const letters=data.query.split('');
        const pattern=letters.map(l=>l+'[\u0591-\u05C7]*').join('');
        const regex=new RegExp(pattern,'g');
        const highlighted=hit.text.replace(regex,m=>`<mark>${m}</mark>`);
        return `<div class="hit">
          <div><span class="ref">${hit.ref}</span></div>
          <div class="text">${highlighted}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    console.error('Text search error:',e);
    $('tsErr').textContent=e.message||'×©×’×™××” ×‘×—×™×¤×•×©';$('tsErr').style.display='block';
  }
  $('tsBtn').disabled=false;
}
$('tsBtn').onclick=doTextSearch;
$('tsQuery').onkeydown=e=>{if(e.key==='Enter')doTextSearch();};

// Initialize book selectors immediately
function initBookSelectors(){
  console.log('Initializing book selectors...');
  bookSelector=createBookSelector('bookSelect');
  wcBookSelector=createBookSelector('wcBookSelect');
  rtBookSelector=createBookSelector('rtBookSelect');
  elsBookSelector=createBookSelector('elsBookSelect');
  tsBookSelector=createBookSelector('tsBookSelect');
  console.log('Book selectors initialized:',{bookSelector,wcBookSelector,rtBookSelector,elsBookSelector,tsBookSelector});
}

// Try to initialize immediately if DOM is ready
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',initBookSelectors);
}else{
  initBookSelectors();
}
</script>
</body>
</html>
