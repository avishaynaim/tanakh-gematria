<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f6f7fb;}
    header{background:#111827;color:#fff;padding:16px 18px;}
    header h1{margin:0;font-size:20px;font-weight:700;}
    header p{margin:6px 0 0;opacity:.9;font-size:13px}
    main{padding:16px;max-width:1100px;margin:0 auto;}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px;margin-bottom:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:13px;color:#374151;display:block;margin-bottom:6px}
    input,select{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;min-width:180px;font-size:14px;background:#fff}
    input[type="number"]{min-width:80px}
    input[type="text"]{min-width:260px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;font-size:14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    button.secondary{background:#e5e7eb;color:#374151}
    button.secondary.active{background:#2563eb;color:#fff}
    .hint{font-size:12px;color:#6b7280;margin-top:10px;line-height:1.5}
    .results{margin-top:10px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-inline-start:8px}
    .hit{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
    .hit .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .ref{font-weight:700;color:#111827}
    .meta{color:#6b7280;font-size:12px}
    .text{margin-top:8px;font-size:16px;line-height:1.7;color:#111827}
    .small{margin-top:6px;font-size:13px;color:#374151}
    .footer{margin-top:10px;color:#6b7280;font-size:12px}
    .error{color:#b91c1c;font-size:13px;margin-top:8px}
    .note{color:#374151;font-size:13px;margin-top:10px}
    /* Tab Navigation */
    .tabs{display:flex;gap:0;margin-bottom:0;background:#fff;border-radius:14px 14px 0 0;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06);flex-wrap:wrap}
    .tab{flex:1;padding:12px 10px;text-align:center;cursor:pointer;font-weight:600;font-size:13px;color:#6b7280;border-bottom:3px solid transparent;transition:all .2s;min-width:100px}
    .tab:hover{background:#f6f7fb;color:#374151}
    .tab.active{color:#2563eb;border-bottom-color:#2563eb;background:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card.no-top-radius{border-radius:0 0 14px 14px;margin-top:0}
    /* Histogram Styles */
    .histogram-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .histogram-controls input[type="number"]{min-width:70px;padding:8px;font-size:13px}
    .histogram-controls button{padding:6px 10px;font-size:12px}
    .range-presets{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
    .range-presets button{padding:6px 10px;font-size:11px}
    .histogram-stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .stat-item{background:#eef2ff;padding:8px 14px;border-radius:10px}
    .stat-value{font-size:18px;font-weight:700;color:#2563eb}
    .stat-label{font-size:11px;color:#6b7280;margin-top:2px}
    .histogram-container{position:relative;width:100%;overflow-x:auto;padding:10px 0}
    .histogram{display:flex;align-items:flex-end;gap:2px;min-height:200px;padding:10px}
    .histogram-bar{background:linear-gradient(to top,#2563eb,#3b82f6);min-width:8px;cursor:pointer;border-radius:3px 3px 0 0;transition:all .15s;flex-shrink:0}
    .histogram-bar:hover{background:linear-gradient(to top,#1d4ed8,#2563eb);transform:scaleY(1.05)}
    .histogram-bar.selected{background:linear-gradient(to top,#dc2626,#ef4444)}
    .bar-label{position:absolute;bottom:-18px;font-size:9px;color:#6b7280;white-space:nowrap;transform:rotate(-45deg);transform-origin:top right}
    .loading-histogram{text-align:center;padding:40px;color:#6b7280}
    .loading-histogram .spinner{border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .range-info{font-size:12px;color:#6b7280;padding:8px 12px;background:#f9fafb;border-radius:8px;margin-bottom:12px}
    /* Modal */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1000;display:none;justify-content:center;align-items:center;padding:20px}
    .modal-overlay.visible{display:flex}
    .modal{background:#fff;border-radius:16px;max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{margin:0;font-size:18px;color:#111827}
    .modal-close{background:#f3f4f6;border:0;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:#e5e7eb}
    .modal-body{padding:16px 20px;overflow-y:auto;flex:1}
    .modal-item{padding:12px;margin:8px 0;background:#f9fafb;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .modal-item:hover{background:#eef2ff;border-color:#2563eb}
    .modal-item-ref{font-weight:700;color:#2563eb;margin-bottom:6px}
    .modal-item-text{font-size:14px;line-height:1.6;color:#374151}
    .modal-item-word{background:#dbeafe;padding:2px 8px;border-radius:6px;font-weight:600;margin-left:8px}
    .modal-stats{color:#6b7280;font-size:13px}
    .no-data{text-align:center;padding:40px;color:#6b7280}
  </style>
</head>
<body>
<header>
  <h1>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</h1>
  <p>×—×¤×© ×œ×¤×™ ××¡×¤×¨ ××• ×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</p>
</header>

<main>
  <div class="tabs">
    <div class="tab active" data-tab="search">ğŸ” ×—×™×¤×•×©</div>
    <div class="tab" data-tab="histogram">ğŸ“Š ×¤×¡×•×§×™×</div>
    <div class="tab" data-tab="histogramWords">ğŸ“Š ××™×œ×™×</div>
  </div>

  <!-- Search Tab -->
  <div id="searchTab" class="tab-content active">
  <div class="card no-top-radius">
    <div class="row">
      <div>
        <label for="mode">××¦×‘ ×—×™×¤×•×©</label>
        <select id="mode">
          <option value="number" selected>×œ×¤×™ ××¡×¤×¨</option>
          <option value="text">×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</option>
        </select>
      </div>
      <div id="numWrap">
        <label for="value">××¡×¤×¨ ×’×™××˜×¨×™×”</label>
        <input id="value" type="number" min="0" placeholder="×œ×“×•×’××”: 347" />
      </div>
      <div id="txtWrap" style="display:none;">
        <label for="text">×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</label>
        <input id="text" type="text" placeholder="×œ×“×•×’××”: ×©×œ×•×" />
      </div>
      <div>
        <label for="kind">×¡×•×’ ×ª×•×¦××”</label>
        <select id="kind">
          <option value="">×”×›×•×œ</option>
          <option value="verse">×¤×¡×•×§×™×</option>
          <option value="word">××™×œ×™×</option>
          <option value="gram">×¨×¦×¤×™ ××™×œ×™×</option>
        </select>
      </div>
      <div>
        <label for="limit">××§×¡×™××•×</label>
        <select id="limit">
          <option value="" selected>×”×›×•×œ</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="500">500</option>
        </select>
      </div>
      <div>
        <button id="btn">×—×¤×©</button>
      </div>
    </div>
    <div id="calc" class="note" style="display:none;"></div>
    <div id="err" class="error" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="meta" id="status">××•×›×Ÿ.</div>
    <div class="results" id="results"></div>
    <div class="footer" id="footer"></div>
  </div>
  </div>

  <!-- Verses Histogram Tab -->
  <div id="histogramTab" class="tab-content">
    <div class="card no-top-radius">
      <h2 style="margin:0 0 12px;font-size:16px;color:#111827">ğŸ“Š ×¤×¡×•×§×™× ×œ×¤×™ ×’×™××˜×¨×™×”</h2>

      <div id="histogramStats" class="histogram-stats"></div>

      <div class="range-presets" id="versesPresets"></div>

      <div class="histogram-controls">
        <label style="margin:0">×˜×•×•×—:</label>
        <input type="number" id="versesMin" placeholder="×-">
        <span>-</span>
        <input type="number" id="versesMax" placeholder="×¢×“">
        <button onclick="applyRange('verses')">×”×¦×’</button>
        <button class="secondary" onclick="jumpToGematria('verses')">×§×¤×•×¥ ×œ×¢×¨×š</button>
      </div>

      <div id="versesRangeInfo" class="range-info" style="display:none"></div>

      <div id="histogramLoading" class="loading-histogram">
        <div class="spinner"></div>
        <div>×˜×•×¢×Ÿ...</div>
      </div>

      <div id="histogramContainer" class="histogram-container" style="display:none">
        <div id="histogram" class="histogram"></div>
      </div>
    </div>
  </div>

  <!-- Words Histogram Tab -->
  <div id="histogramWordsTab" class="tab-content">
    <div class="card no-top-radius">
      <h2 style="margin:0 0 12px;font-size:16px;color:#111827">ğŸ“Š ××™×œ×™× ×œ×¤×™ ×’×™××˜×¨×™×”</h2>

      <div id="histogramWordsStats" class="histogram-stats"></div>

      <div class="range-presets" id="wordsPresets"></div>

      <div class="histogram-controls">
        <label style="margin:0">×˜×•×•×—:</label>
        <input type="number" id="wordsMin" placeholder="×-">
        <span>-</span>
        <input type="number" id="wordsMax" placeholder="×¢×“">
        <button onclick="applyRange('words')">×”×¦×’</button>
        <button class="secondary" onclick="jumpToGematria('words')">×§×¤×•×¥ ×œ×¢×¨×š</button>
      </div>

      <div id="wordsRangeInfo" class="range-info" style="display:none"></div>

      <div id="histogramWordsLoading" class="loading-histogram">
        <div class="spinner"></div>
        <div>×˜×•×¢×Ÿ...</div>
      </div>

      <div id="histogramWordsContainer" class="histogram-container" style="display:none">
        <div id="histogramWords" class="histogram"></div>
      </div>
    </div>
  </div>
</main>

<div id="modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">×’×™××˜×¨×™×”: 0</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

// ========== Search Tab ==========
function showError(msg) {
  $("err").style.display = msg ? "block" : "none";
  $("err").textContent = msg || "";
}

function showCalc(msg) {
  $("calc").style.display = msg ? "block" : "none";
  $("calc").textContent = msg || "";
}

function kindLabel(k) {
  return {verse: "×¤×¡×•×§", word: "××™×œ×”", gram: "×¨×¦×£"}[k] || k;
}

function syncMode() {
  const mode = $("mode").value;
  $("numWrap").style.display = mode === "number" ? "block" : "none";
  $("txtWrap").style.display = mode === "text" ? "block" : "none";
  showCalc(""); showError("");
}
$("mode").addEventListener("change", syncMode);

async function doSearch() {
  showError(""); showCalc("");
  const mode = $("mode").value;
  const kind = $("kind").value;
  const limit = $("limit").value;
  const params = new URLSearchParams();
  if (limit) params.set("limit", limit);
  if (kind) params.set("kind", kind);

  if (mode === "number") {
    const value = $("value").value.trim();
    if (!value) { showError("× × ×œ×”×–×™×Ÿ ××¡×¤×¨."); return; }
    params.set("value", value);
  } else {
    const text = $("text").value.trim();
    if (!text) { showError("× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜."); return; }
    try {
      const g = await (await fetch("/gematria?text=" + encodeURIComponent(text))).json();
      showCalc(`×’×™××˜×¨×™×”: ${g.gematria}`);
    } catch(e) { showError(e.message); return; }
    params.set("text", text);
  }

  $("btn").disabled = true;
  $("status").textContent = "××—×¤×©...";
  $("results").innerHTML = "";

  try {
    const data = await (await fetch("/search?" + params)).json();
    $("status").textContent = `× ××¦××• ${data.length} ×ª×•×¦××•×ª.`;
    if (!data.length) { $("results").innerHTML = "<div class='meta'>××™×Ÿ ×”×ª×××•×ª.</div>"; return; }

    $("results").innerHTML = data.map(h => `
      <div class="hit">
        <div class="top">
          <div><span class="ref">${h.ref}</span><span class="pill">${kindLabel(h.kind)}</span></div>
          <div class="meta">×’×™××˜×¨×™×”: ${h.gematria}</div>
        </div>
        <div class="text">${h.text}</div>
        ${h.match_text ? `<div class="small">×”×ª×××”: ${h.match_text}</div>` : ''}
      </div>
    `).join('');
  } catch(e) {
    showError(e.message);
  } finally {
    $("btn").disabled = false;
  }
}

$("btn").addEventListener("click", doSearch);
$("value").addEventListener("keydown", e => { if(e.key === "Enter") doSearch(); });
$("text").addEventListener("keydown", e => { if(e.key === "Enter") doSearch(); });
syncMode();

// ========== Tabs ==========
const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const t = tab.dataset.tab;
    tabs.forEach(x => x.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    $(t + 'Tab').classList.add('active');
    if (t === 'histogram' && !versesLoaded) loadHistogram('verses');
    if (t === 'histogramWords' && !wordsLoaded) loadHistogram('words');
  });
});

// ========== Histogram ==========
let versesData = [], wordsData = [];
let versesLoaded = false, wordsLoaded = false;
let currentRange = { verses: { min: 0, max: 0 }, words: { min: 0, max: 0 } };
let selectedBar = null;

async function loadHistogram(type) {
  const isVerses = type === 'verses';
  const loading = $(isVerses ? 'histogramLoading' : 'histogramWordsLoading');
  const container = $(isVerses ? 'histogramContainer' : 'histogramWordsContainer');
  const statsDiv = $(isVerses ? 'histogramStats' : 'histogramWordsStats');
  const presetsDiv = $(isVerses ? 'versesPresets' : 'wordsPresets');

  try {
    const url = isVerses ? '/histogram' : '/histogram/words';
    const data = await (await fetch(url)).json();

    if (isVerses) { versesData = data; versesLoaded = true; }
    else { wordsData = data; wordsLoaded = true; }

    const total = data.reduce((s, b) => s + b.count, 0);
    const minGem = data[0]?.gematria || 0;
    const maxGem = data[data.length - 1]?.gematria || 0;
    const maxCount = Math.max(...data.map(b => b.count));

    statsDiv.innerHTML = `
      <div class="stat-item"><div class="stat-value">${total.toLocaleString()}</div><div class="stat-label">×¡×”×´×› ${isVerses ? '×¤×¡×•×§×™×' : '××™×œ×™×'}</div></div>
      <div class="stat-item"><div class="stat-value">${data.length.toLocaleString()}</div><div class="stat-label">×¢×¨×›×™× ×©×•× ×™×</div></div>
      <div class="stat-item"><div class="stat-value">${minGem}-${maxGem}</div><div class="stat-label">×˜×•×•×—</div></div>
    `;

    // Create range presets
    const ranges = [];
    for (let i = minGem; i <= maxGem; i += 500) {
      ranges.push({ min: i, max: Math.min(i + 499, maxGem) });
    }
    presetsDiv.innerHTML = ranges.slice(0, 20).map(r =>
      `<button class="secondary" onclick="setRange('${type}', ${r.min}, ${r.max})">${r.min}-${r.max}</button>`
    ).join('');

    // Set initial range (first 500)
    currentRange[type] = { min: minGem, max: Math.min(minGem + 499, maxGem) };
    $(isVerses ? 'versesMin' : 'wordsMin').value = currentRange[type].min;
    $(isVerses ? 'versesMax' : 'wordsMax').value = currentRange[type].max;

    renderHistogram(type);
    loading.style.display = 'none';
    container.style.display = 'block';
  } catch(e) {
    loading.innerHTML = `<div class="error">×©×’×™××”: ${e.message}</div>`;
  }
}

function setRange(type, min, max) {
  currentRange[type] = { min, max };
  const isVerses = type === 'verses';
  $(isVerses ? 'versesMin' : 'wordsMin').value = min;
  $(isVerses ? 'versesMax' : 'wordsMax').value = max;
  renderHistogram(type);

  // Update active button
  const presets = $(isVerses ? 'versesPresets' : 'wordsPresets').querySelectorAll('button');
  presets.forEach(b => {
    const [bMin, bMax] = b.textContent.split('-').map(Number);
    b.classList.toggle('active', bMin === min && bMax === max);
  });
}

function applyRange(type) {
  const isVerses = type === 'verses';
  const min = parseInt($(isVerses ? 'versesMin' : 'wordsMin').value) || 0;
  const max = parseInt($(isVerses ? 'versesMax' : 'wordsMax').value) || 99999;
  setRange(type, min, max);
}

function renderHistogram(type) {
  const isVerses = type === 'verses';
  const data = isVerses ? versesData : wordsData;
  const container = $(isVerses ? 'histogram' : 'histogramWords');
  const infoDiv = $(isVerses ? 'versesRangeInfo' : 'wordsRangeInfo');
  const { min, max } = currentRange[type];

  // Filter data by range
  const filtered = data.filter(b => b.gematria >= min && b.gematria <= max);

  if (!filtered.length) {
    container.innerHTML = '<div class="no-data">××™×Ÿ × ×ª×•× ×™× ×‘×˜×•×•×— ×–×”</div>';
    infoDiv.style.display = 'none';
    return;
  }

  const maxCount = Math.max(...filtered.map(b => b.count));
  const height = 180;
  const barWidth = Math.max(12, Math.min(40, Math.floor((container.parentElement.clientWidth - 40) / filtered.length)));

  container.innerHTML = filtered.map((bucket, i) => {
    const barHeight = Math.max(4, (bucket.count / maxCount) * height);
    return `<div class="histogram-bar" style="height:${barHeight}px;width:${barWidth}px" data-idx="${i}" onclick="showBucketModal('${type}', ${data.indexOf(bucket)})"></div>`;
  }).join('');

  infoDiv.textContent = `××¦×™×’ ${filtered.length} ×¢×¨×›×™× (${min} ×¢×“ ${max}) â€¢ ×œ×—×¥ ×¢×œ ×¢××•×“×” ×œ×¤×¨×˜×™×`;
  infoDiv.style.display = 'block';
}

function jumpToGematria(type) {
  const isVerses = type === 'verses';
  const input = $(isVerses ? 'versesMin' : 'wordsMin');
  const target = parseInt(input.value) || 0;

  // Set range around target (Â±250)
  const min = Math.max(1, target - 250);
  const max = target + 250;
  setRange(type, min, max);

  // Find and click the target bar
  const data = isVerses ? versesData : wordsData;
  const idx = data.findIndex(b => b.gematria >= target);
  if (idx >= 0) {
    setTimeout(() => showBucketModal(type, idx), 100);
  }
}

// ========== Modal ==========
function showBucketModal(type, dataIdx) {
  const data = type === 'verses' ? versesData : wordsData;
  const bucket = data[dataIdx];
  if (!bucket) return;

  // Highlight bar
  document.querySelectorAll('.histogram-bar').forEach(b => b.classList.remove('selected'));
  const bars = $(type === 'verses' ? 'histogram' : 'histogramWords').querySelectorAll('.histogram-bar');
  const filtered = data.filter(b => b.gematria >= currentRange[type].min && b.gematria <= currentRange[type].max);
  const filteredIdx = filtered.indexOf(bucket);
  if (filteredIdx >= 0 && bars[filteredIdx]) bars[filteredIdx].classList.add('selected');

  const isVerses = type === 'verses';
  const items = isVerses ? bucket.verses : bucket.words;
  const label = isVerses ? '×¤×¡×•×§×™×' : '××™×œ×™×';

  $('modalTitle').textContent = `×’×™××˜×¨×™×”: ${bucket.gematria} (${bucket.count} ${label})`;
  $('modalBody').innerHTML = items.slice(0, 100).map(item => {
    if (isVerses) {
      return `<div class="modal-item" onclick="searchFromModal(${bucket.gematria}, 'verse')">
        <div class="modal-item-ref">${item.ref}</div>
        <div class="modal-item-text">${item.text}</div>
      </div>`;
    } else {
      return `<div class="modal-item" onclick="searchFromModal(${bucket.gematria}, 'word')">
        <div class="modal-item-ref">${item.ref}<span class="modal-item-word">${item.word}</span></div>
        <div class="modal-item-text">${item.verse_text}</div>
      </div>`;
    }
  }).join('') + (items.length > 100 ? `<div class="modal-stats">××¦×™×’ 100 ××ª×•×š ${items.length}</div>` : '');

  $('modal').classList.add('visible');
}

function closeModal() {
  $('modal').classList.remove('visible');
  document.querySelectorAll('.histogram-bar.selected').forEach(b => b.classList.remove('selected'));
}

function searchFromModal(gematria, kind) {
  closeModal();
  tabs[0].click();
  $('mode').value = 'number';
  syncMode();
  $('value').value = gematria;
  $('kind').value = kind;
  doSearch();
}

$('modal').addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Enter key on range inputs
['versesMin', 'versesMax'].forEach(id => $(id)?.addEventListener('keydown', e => { if(e.key === 'Enter') applyRange('verses'); }));
['wordsMin', 'wordsMax'].forEach(id => $(id)?.addEventListener('keydown', e => { if(e.key === 'Enter') applyRange('words'); }));
</script>
</body>
</html>
