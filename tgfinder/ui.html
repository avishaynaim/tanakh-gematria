<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#f6f7fb}
    header{background:#111827;color:#fff;padding:14px 16px}
    header h1{margin:0;font-size:18px;font-weight:700}
    main{padding:12px;max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:12px;color:#374151;display:block;margin-bottom:4px}
    input,select{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;background:#fff}
    input[type="number"]{width:100px}
    button{padding:8px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;font-size:13px;cursor:pointer}
    button:disabled{opacity:.5}
    button.secondary{background:#e5e7eb;color:#374151}
    button.small{padding:5px 10px;font-size:11px}
    .tabs{display:flex;background:#fff;border-radius:12px 12px 0 0;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .tab{flex:1;padding:12px;text-align:center;cursor:pointer;font-weight:600;font-size:13px;color:#6b7280;border-bottom:3px solid transparent}
    .tab:hover{background:#f9fafb}
    .tab.active{color:#2563eb;border-bottom-color:#2563eb}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card.no-top{border-radius:0 0 12px 12px;margin-top:0}
    .meta{color:#6b7280;font-size:12px}
    .error{color:#b91c1c;font-size:13px}
    .results{margin-top:10px}
    .hit{border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-top:8px}
    .ref{font-weight:700;color:#111827}
    .pill{display:inline-block;padding:2px 6px;border-radius:99px;background:#eef2ff;color:#3730a3;font-size:11px;margin-inline-start:6px}
    .text{margin-top:6px;font-size:15px;line-height:1.6}
    /* Histogram */
    .hist-section{margin-bottom:16px}
    .hist-section h3{margin:0 0 8px;font-size:14px;color:#374151;display:flex;align-items:center;gap:8px}
    .hist-section h3 .back-btn{font-size:12px}
    .histogram{display:flex;align-items:flex-end;gap:2px;min-height:150px;padding:8px 4px;background:#f9fafb;border-radius:8px;overflow-x:auto}
    .histogram.overview{min-height:120px}
    .histogram.detail{min-height:180px}
    .bar{background:linear-gradient(to top,#2563eb,#60a5fa);border-radius:3px 3px 0 0;cursor:pointer;transition:all .15s;position:relative;min-width:20px;flex-shrink:0}
    .bar:hover{background:linear-gradient(to top,#1d4ed8,#3b82f6);transform:scaleY(1.03)}
    .bar.selected{background:linear-gradient(to top,#dc2626,#f87171)}
    .bar-label{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:#6b7280;white-space:nowrap}
    .bar-count{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:9px;color:#374151;font-weight:600}
    .stats{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .stat{background:#eef2ff;padding:6px 12px;border-radius:8px}
    .stat b{color:#2563eb;font-size:16px}
    .stat span{font-size:11px;color:#6b7280;display:block}
    .hint{font-size:11px;color:#6b7280;margin-top:6px}
    .loading{text-align:center;padding:30px;color:#6b7280}
    .spinner{border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin:0 auto 8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .no-data{text-align:center;padding:20px;color:#9ca3af}
    .jump-input{display:flex;gap:6px;align-items:center;margin-top:8px}
    .jump-input input{width:80px}
    .top-values{margin-bottom:12px;padding:10px;background:#fefce8;border-radius:8px;border:1px solid #fef08a}
    .top-values h4{margin:0 0 8px;font-size:13px;color:#854d0e}
    .top-chips{display:flex;gap:6px;flex-wrap:wrap}
    .top-chip{background:#fef9c3;border:1px solid #fde047;padding:4px 10px;border-radius:6px;font-size:12px;cursor:pointer;transition:all .15s}
    .top-chip:hover{background:#fde047}
    .top-chip b{color:#a16207;margin-left:4px}
    /* Modal */
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;justify-content:center;align-items:center;padding:16px}
    .modal-bg.visible{display:flex}
    .modal{background:#fff;border-radius:14px;max-width:480px;width:100%;max-height:75vh;display:flex;flex-direction:column}
    .modal-head{padding:14px 16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-head h3{margin:0;font-size:16px}
    .modal-close{background:#f3f4f6;border:0;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:16px}
    .modal-body{padding:12px 16px;overflow-y:auto;flex:1}
    .modal-item{padding:10px;margin:6px 0;background:#f9fafb;border-radius:8px;cursor:pointer;border:2px solid transparent}
    .modal-item:hover{background:#eef2ff;border-color:#2563eb}
    .modal-ref{font-weight:600;color:#2563eb;margin-bottom:4px}
    .modal-text{font-size:13px;color:#374151;line-height:1.5}
    .modal-word{background:#dbeafe;padding:2px 6px;border-radius:4px;font-weight:600;margin-left:6px;font-size:12px}
    mark{background:#fef08a;padding:1px 4px;border-radius:3px;font-weight:600}
  </style>
</head>
<body>
<header><h1>ğŸ”¢ ×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</h1></header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="search">ğŸ” ×—×™×¤×•×©</div>
    <div class="tab" data-tab="histogram">ğŸ“Š ×¤×¡×•×§×™×</div>
    <div class="tab" data-tab="histogramWords">ğŸ“Š ××™×œ×™×</div>
    <div class="tab" data-tab="wordCount">ğŸ”¢ ×¡×¤×™×¨×ª ××™×œ×™×</div>
  </div>

  <!-- Search -->
  <div id="searchTab" class="tab-content active">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××¦×‘</label>
          <select id="mode"><option value="number">××¡×¤×¨</option><option value="text">×˜×§×¡×˜</option></select>
        </div>
        <div id="numWrap">
          <label>×’×™××˜×¨×™×”</label>
          <input id="value" type="number" min="0" placeholder="347">
        </div>
        <div id="txtWrap" style="display:none">
          <label>×˜×§×¡×˜</label>
          <input id="text" type="text" placeholder="×©×œ×•×" style="width:150px">
        </div>
        <div>
          <label>×¡×•×’</label>
          <select id="kind"><option value="">×”×›×•×œ</option><option value="verse">×¤×¡×•×§×™×</option><option value="word">××™×œ×™×</option></select>
        </div>
        <div><label>&nbsp;</label><button id="btn">×—×¤×©</button></div>
      </div>
      <div id="calc" class="hint" style="display:none"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div class="meta" id="status">××•×›×Ÿ</div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <!-- Verses Histogram -->
  <div id="histogramTab" class="tab-content">
    <div class="card no-top">
      <div id="vStats" class="stats"></div>

      <div id="vTopSection" class="top-values"></div>

      <div class="hist-section">
        <h3>ğŸ“Š ×ª××•× ×” ×›×œ×œ×™×ª <span class="hint">(×œ×—×¥ ×¢×œ ×˜×•×•×— ×œ×¤×™×¨×•×˜)</span></h3>
        <div id="vOverview" class="histogram overview"></div>
      </div>

      <div id="vDetailSection" class="hist-section" style="display:none">
        <h3>
          <button class="secondary small back-btn" onclick="hideDetail('verses')">â† ×—×–×•×¨</button>
          <span id="vDetailTitle">×¤×™×¨×•×˜</span>
        </h3>
        <div id="vDetail" class="histogram detail"></div>
      </div>

      <div class="jump-input">
        <label>×§×¤×•×¥ ×œ×’×™××˜×¨×™×”:</label>
        <input type="number" id="vJump" placeholder="500">
        <button class="small" onclick="jumpTo('verses')">××¦×</button>
      </div>

      <div id="vLoading" class="loading"><div class="spinner"></div>×˜×•×¢×Ÿ...</div>
    </div>
  </div>

  <!-- Words Histogram -->
  <div id="histogramWordsTab" class="tab-content">
    <div class="card no-top">
      <div id="wStats" class="stats"></div>

      <div id="wTopSection" class="top-values"></div>

      <div class="hist-section">
        <h3>ğŸ“Š ×ª××•× ×” ×›×œ×œ×™×ª <span class="hint">(×œ×—×¥ ×¢×œ ×˜×•×•×— ×œ×¤×™×¨×•×˜)</span></h3>
        <div id="wOverview" class="histogram overview"></div>
      </div>

      <div id="wDetailSection" class="hist-section" style="display:none">
        <h3>
          <button class="secondary small back-btn" onclick="hideDetail('words')">â† ×—×–×•×¨</button>
          <span id="wDetailTitle">×¤×™×¨×•×˜</span>
        </h3>
        <div id="wDetail" class="histogram detail"></div>
      </div>

      <div class="jump-input">
        <label>×§×¤×•×¥ ×œ×’×™××˜×¨×™×”:</label>
        <input type="number" id="wJump" placeholder="50">
        <button class="small" onclick="jumpTo('words')">××¦×</button>
      </div>

      <div id="wLoading" class="loading"><div class="spinner"></div>×˜×•×¢×Ÿ...</div>
    </div>
  </div>

  <!-- Word Count -->
  <div id="wordCountTab" class="tab-content">
    <div class="card no-top">
      <div class="row">
        <div>
          <label>××™×œ×” ×œ×—×™×¤×•×©</label>
          <input id="wcWord" type="text" placeholder="×©×œ×•×" style="width:180px">
        </div>
        <div><label>&nbsp;</label><button id="wcBtn">×—×¤×©</button></div>
      </div>
      <div id="wcErr" class="error" style="display:none"></div>
    </div>
    <div class="card">
      <div id="wcStats" class="stats" style="display:none"></div>
      <div id="wcStatus" class="meta">×”×–×Ÿ ××™×œ×” ×œ×—×™×¤×•×©</div>
      <div id="wcResults" class="results"></div>
    </div>
  </div>
</main>

<!-- Modal -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle"></h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
let vData=[],wData=[],vLoaded=false,wLoaded=false;

// Search
function syncMode(){
  $("numWrap").style.display=$("mode").value==="number"?"block":"none";
  $("txtWrap").style.display=$("mode").value==="text"?"block":"none";
}
$("mode").onchange=syncMode;

async function doSearch(){
  const mode=$("mode").value,kind=$("kind").value;
  const params=new URLSearchParams();
  if(kind)params.set("kind",kind);
  params.set("limit","500");

  if(mode==="number"){
    const v=$("value").value.trim();
    if(!v){$("err").textContent="×”×–×Ÿ ××¡×¤×¨";$("err").style.display="block";return;}
    params.set("value",v);
  }else{
    const t=$("text").value.trim();
    if(!t){$("err").textContent="×”×–×Ÿ ×˜×§×¡×˜";$("err").style.display="block";return;}
    try{
      const g=await(await fetch("/gematria?text="+encodeURIComponent(t))).json();
      $("calc").textContent="×’×™××˜×¨×™×”: "+g.gematria;$("calc").style.display="block";
    }catch(e){$("err").textContent=e.message;$("err").style.display="block";return;}
    params.set("text",t);
  }

  $("btn").disabled=true;$("status").textContent="××—×¤×©...";$("results").innerHTML="";$("err").style.display="none";
  const kindHeb={verse:'×¤×¡×•×§',word:'××™×œ×”',gram:'×¦×™×¨×•×£'};
  try{
    const data=await(await fetch("/search?"+params)).json();
    $("status").textContent="× ××¦××• "+data.length+" ×ª×•×¦××•×ª";
    $("results").innerHTML=data.map(h=>`<div class="hit"><div><span class="ref">${h.ref}</span><span class="pill">${kindHeb[h.kind]||h.kind}</span><span class="meta" style="float:left">×’×™××˜×¨×™×”: ${h.gematria}</span></div><div class="text">${h.text}</div>${h.match_text?`<div class="meta">×”×ª×××”: ${h.match_text}</div>`:''}</div>`).join('');
  }catch(e){$("err").textContent=e.message;$("err").style.display="block";}
  $("btn").disabled=false;
}
$("btn").onclick=doSearch;
$("value").onkeydown=e=>{if(e.key==="Enter")doSearch();};
$("text").onkeydown=e=>{if(e.key==="Enter")doSearch();};
syncMode();

// Tabs
function activateTab(tabName){
  const tab=document.querySelector(`.tab[data-tab="${tabName}"]`);
  if(!tab)return;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  tab.classList.add('active');
  $(tabName+'Tab').classList.add('active');
  if(tabName==='histogram'&&!vLoaded)loadData('verses');
  if(tabName==='histogramWords'&&!wLoaded)loadData('words');
}
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick=()=>{
    const tabName=tab.dataset.tab;
    history.pushState(null,null,'#'+tabName);
    activateTab(tabName);
  };
});
// Handle URL hash on load and back/forward
function handleHash(){
  const hash=location.hash.slice(1)||'search';
  activateTab(hash);
}
window.addEventListener('hashchange',handleHash);
handleHash();

// Load histogram data
async function loadData(type){
  const isV=type==='verses';
  const loading=$(isV?'vLoading':'wLoading');
  const statsDiv=$(isV?'vStats':'wStats');
  const overviewDiv=$(isV?'vOverview':'wOverview');
  const topDiv=$(isV?'vTopSection':'wTopSection');

  try{
    const data=await(await fetch(isV?'/histogram':'/histogram/words')).json();
    if(isV){vData=data;vLoaded=true;}else{wData=data;wLoaded=true;}

    const total=data.reduce((s,b)=>s+b.count,0);
    const minG=data[0]?.gematria||0;
    const maxG=data[data.length-1]?.gematria||0;

    // Find top 10 by count
    const sorted=[...data].sort((a,b)=>b.count-a.count);
    const top10=sorted.slice(0,10);

    statsDiv.innerHTML=`
      <div class="stat"><b>${total.toLocaleString()}</b><span>${isV?'×¤×¡×•×§×™×':'××™×œ×™×'}</span></div>
      <div class="stat"><b>${data.length.toLocaleString()}</b><span>×¢×¨×›×™×</span></div>
      <div class="stat"><b>${minG}-${maxG}</b><span>×˜×•×•×—</span></div>
    `;

    // Render top values
    topDiv.innerHTML=`
      <h4>ğŸ† ×¢×¨×›×™ ×”×©×™× (×”×›×™ × ×¤×•×¦×™×)</h4>
      <div class="top-chips">
        ${top10.map((d,i)=>`<div class="top-chip" onclick="showModal('${type}',${d.gematria})">${i+1}. ×’×™××˜×¨×™×” ${d.gematria}<b>${d.count}</b></div>`).join('')}
      </div>
    `;

    // Create overview buckets (group into ~40 buckets)
    const bucketSize=Math.ceil((maxG-minG+1)/40);
    const buckets=[];
    for(let i=minG;i<=maxG;i+=bucketSize){
      const end=Math.min(i+bucketSize-1,maxG);
      const items=data.filter(d=>d.gematria>=i&&d.gematria<=end);
      const count=items.reduce((s,d)=>s+d.count,0);
      buckets.push({min:i,max:end,count,items});
    }

    renderOverview(type,buckets,overviewDiv);
    loading.style.display='none';
  }catch(e){
    loading.innerHTML=`<div class="error">×©×’×™××”: ${e.message}</div>`;
  }
}

function renderOverview(type,buckets,container){
  const maxCount=Math.max(...buckets.map(b=>b.count));
  const h=100;

  container.innerHTML=buckets.map((b,i)=>{
    const bh=Math.max(4,b.count/maxCount*h);
    return `<div class="bar" style="height:${bh}px;flex:1;min-width:16px" onclick="showDetail('${type}',${i})" data-idx="${i}">
      <span class="bar-label">${b.min}-${b.max}</span>
      ${b.count>0?`<span class="bar-count">${b.count>999?(b.count/1000).toFixed(1)+'k':b.count}</span>`:''}
    </div>`;
  }).join('');

  // Store buckets for later
  if(type==='verses')window.vBuckets=buckets;
  else window.wBuckets=buckets;
}

function showDetail(type,bucketIdx){
  const isV=type==='verses';
  const buckets=isV?window.vBuckets:window.wBuckets;
  const bucket=buckets[bucketIdx];
  const section=$(isV?'vDetailSection':'wDetailSection');
  const title=$(isV?'vDetailTitle':'wDetailTitle');
  const container=$(isV?'vDetail':'wDetail');
  const data=isV?vData:wData;

  // Get items in this range
  const items=data.filter(d=>d.gematria>=bucket.min&&d.gematria<=bucket.max);

  if(!items.length){
    container.innerHTML='<div class="no-data">××™×Ÿ × ×ª×•× ×™×</div>';
    section.style.display='block';
    return;
  }

  const maxCount=Math.max(...items.map(d=>d.count));
  const h=150;
  const barW=Math.max(20,Math.min(50,Math.floor((container.clientWidth||600)/items.length)-4));

  container.innerHTML=items.map((d,i)=>{
    const bh=Math.max(4,d.count/maxCount*h);
    return `<div class="bar" style="height:${bh}px;width:${barW}px" onclick="showModal('${type}',${d.gematria})">
      <span class="bar-label">${d.gematria}</span>
      <span class="bar-count">${d.count}</span>
    </div>`;
  }).join('');

  title.textContent=`×˜×•×•×— ${bucket.min}-${bucket.max} (${items.length} ×¢×¨×›×™×)`;
  section.style.display='block';
  section.scrollIntoView({behavior:'smooth',block:'nearest'});
}

function hideDetail(type){
  $(type==='verses'?'vDetailSection':'wDetailSection').style.display='none';
}

function jumpTo(type){
  const isV=type==='verses';
  const target=parseInt($(isV?'vJump':'wJump').value)||0;
  const buckets=isV?window.vBuckets:window.wBuckets;
  if(!buckets)return;

  // Find bucket containing target
  const idx=buckets.findIndex(b=>target>=b.min&&target<=b.max);
  if(idx>=0){
    showDetail(type,idx);
    // After detail renders, show modal for exact value
    setTimeout(()=>showModal(type,target),200);
  }
}

// Modal
function showModal(type,gematria){
  const data=type==='verses'?vData:wData;
  const bucket=data.find(d=>d.gematria===gematria);
  if(!bucket)return;

  const isV=type==='verses';
  const items=isV?bucket.verses:bucket.words;
  const label=isV?'×¤×¡×•×§×™×':'××™×œ×™×';

  $('modalTitle').textContent=`×’×™××˜×¨×™×” ${gematria} (${bucket.count} ${label})`;
  $('modalBody').innerHTML=items.slice(0,100).map(item=>{
    if(isV){
      return `<div class="modal-item" onclick="searchGem(${gematria},'verse')">
        <div class="modal-ref">${item.ref}</div>
        <div class="modal-text">${item.text}</div>
      </div>`;
    }else{
      return `<div class="modal-item" onclick="searchGem(${gematria},'word')">
        <div class="modal-ref">${item.ref}<span class="modal-word">${item.word}</span></div>
        <div class="modal-text">${item.verse_text}</div>
      </div>`;
    }
  }).join('')+(items.length>100?`<div class="meta" style="text-align:center;padding:10px">××¦×™×’ 100 ××ª×•×š ${items.length}</div>`:'');

  $('modal').classList.add('visible');
}

function closeModal(){$('modal').classList.remove('visible');}
function searchGem(g,k){
  closeModal();
  document.querySelectorAll('.tab')[0].click();
  $('mode').value='number';syncMode();
  $('value').value=g;$('kind').value=k;
  doSearch();
}

$('modal').onclick=e=>{if(e.target.id==='modal')closeModal();};
document.onkeydown=e=>{if(e.key==='Escape')closeModal();};

// Word Count Search
async function doWordSearch(){
  const word=$('wcWord').value.trim();
  if(!word){$('wcErr').textContent='×”×–×Ÿ ××™×œ×”';$('wcErr').style.display='block';return;}

  $('wcBtn').disabled=true;$('wcStatus').textContent='××—×¤×©...';$('wcResults').innerHTML='';$('wcErr').style.display='none';$('wcStats').style.display='none';

  try{
    const data=await(await fetch('/word-search?word='+encodeURIComponent(word))).json();

    $('wcStats').innerHTML=`
      <div class="stat"><b>${data.count.toLocaleString()}</b><span>××•×¤×¢×™× ×‘×ª× ×´×š</span></div>
      <div class="stat"><b>${data.word}</b><span>××™×œ×” (×œ×œ× × ×™×§×•×“)</span></div>
    `;
    $('wcStats').style.display='flex';

    if(data.count===0){
      $('wcStatus').textContent='×œ× × ××¦××• ×ª×•×¦××•×ª';
    }else{
      $('wcStatus').textContent=`× ××¦××• ${data.count.toLocaleString()} ××•×¤×¢×™×`;
      $('wcResults').innerHTML=data.locations.map(loc=>{
        // Highlight all occurrences of word_text in verse
        const escaped=loc.word_text.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        const highlighted=loc.verse_text.replace(new RegExp(escaped,'g'),`<mark>${loc.word_text}</mark>`);
        return `<div class="hit">
          <div><span class="ref">${loc.ref}</span><span class="pill">${loc.word_text}</span></div>
          <div class="text">${highlighted}</div>
        </div>`;
      }).join('');
    }
  }catch(e){
    $('wcErr').textContent=e.message;$('wcErr').style.display='block';
  }
  $('wcBtn').disabled=false;
}
$('wcBtn').onclick=doWordSearch;
$('wcWord').onkeydown=e=>{if(e.key==='Enter')doWordSearch();};
</script>
</body>
</html>
