<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5" />
  <title>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f6f7fb;}
    header{background:#111827;color:#fff;padding:16px 18px;}
    header h1{margin:0;font-size:20px;font-weight:700;}
    header p{margin:6px 0 0;opacity:.9;font-size:13px}
    main{padding:16px;max-width:1100px;margin:0 auto;}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px;margin-bottom:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:13px;color:#374151;display:block;margin-bottom:6px}
    input,select{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;min-width:180px;font-size:14px;background:#fff}
    input[type="number"]{min-width:160px}
    input[type="text"]{min-width:260px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;font-size:14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#6b7280;margin-top:10px;line-height:1.5}
    .results{margin-top:10px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-inline-start:8px}
    .hit{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
    .hit .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .ref{font-weight:700;color:#111827}
    .meta{color:#6b7280;font-size:12px}
    .text{margin-top:8px;font-size:16px;line-height:1.7;color:#111827}
    .small{margin-top:6px;font-size:13px;color:#374151}
    .footer{margin-top:10px;color:#6b7280;font-size:12px}
    .error{color:#b91c1c;font-size:13px;margin-top:8px}
    .note{color:#374151;font-size:13px;margin-top:10px}
    /* Tab Navigation */
    .tabs{display:flex;gap:0;margin-bottom:0;background:#fff;border-radius:14px 14px 0 0;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06);flex-wrap:wrap}
    .tab{flex:1;padding:12px 10px;text-align:center;cursor:pointer;font-weight:600;font-size:13px;color:#6b7280;border-bottom:3px solid transparent;transition:all .2s;min-width:100px}
    .tab:hover{background:#f6f7fb;color:#374151}
    .tab.active{color:#2563eb;border-bottom-color:#2563eb;background:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card.no-top-radius{border-radius:0 0 14px 14px;margin-top:0}
    /* Histogram Styles */
    .histogram-controls{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .histogram-controls button{padding:8px 12px;font-size:12px}
    .zoom-info{font-size:12px;color:#6b7280;margin-right:auto}
    .histogram-container{position:relative;width:100%;overflow-x:auto;overflow-y:hidden;padding-bottom:20px;touch-action:pan-x pinch-zoom}
    .histogram-wrapper{transform-origin:left center;transition:transform 0.1s ease-out}
    .histogram{display:flex;align-items:flex-end;gap:1px;min-height:300px;padding:20px 10px 40px;position:relative}
    .histogram-bar{background:linear-gradient(to top,#2563eb,#3b82f6);min-width:2px;cursor:pointer;border-radius:2px 2px 0 0;transition:background .15s;position:relative;flex-shrink:0}
    .histogram-bar:hover{background:linear-gradient(to top,#1d4ed8,#2563eb)}
    .histogram-bar.selected{background:linear-gradient(to top,#dc2626,#ef4444)}
    .histogram-stats{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .stat-item{background:#eef2ff;padding:8px 14px;border-radius:10px}
    .stat-value{font-size:18px;font-weight:700;color:#2563eb}
    .stat-label{font-size:11px;color:#6b7280;margin-top:2px}
    .loading-histogram{text-align:center;padding:40px;color:#6b7280}
    .loading-histogram .spinner{border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Modal for histogram details */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1000;display:none;justify-content:center;align-items:center;padding:20px}
    .modal-overlay.visible{display:flex}
    .modal{background:#fff;border-radius:16px;max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,.3)}
    .modal-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-header h3{margin:0;font-size:18px;color:#111827}
    .modal-close{background:#f3f4f6;border:0;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center}
    .modal-close:hover{background:#e5e7eb}
    .modal-body{padding:16px 20px;overflow-y:auto;flex:1}
    .modal-item{padding:12px;margin:8px 0;background:#f9fafb;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .modal-item:hover{background:#eef2ff;border-color:#2563eb}
    .modal-item-ref{font-weight:700;color:#2563eb;margin-bottom:6px}
    .modal-item-text{font-size:14px;line-height:1.6;color:#374151}
    .modal-item-word{background:#dbeafe;padding:2px 8px;border-radius:6px;font-weight:600;margin-left:8px}
    .modal-stats{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
<header>
  <h1>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</h1>
  <p>×—×¤×© ×œ×¤×™ ××¡×¤×¨ ××• ×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª (×”××¤×œ×™×§×¦×™×” ××—×©×‘×ª ×’×™××˜×¨×™×” ×•××– ××—×¤×©×ª ×”×ª×××•×ª).</p>
</header>

<main>
  <!-- Tab Navigation -->
  <div class="tabs">
    <div class="tab active" data-tab="search">ğŸ” ×—×™×¤×•×©</div>
    <div class="tab" data-tab="histogram">ğŸ“Š ×¤×¡×•×§×™×</div>
    <div class="tab" data-tab="histogramWords">ğŸ“Š ××™×œ×™×</div>
  </div>

  <!-- Search Tab Content -->
  <div id="searchTab" class="tab-content active">
  <div class="card no-top-radius">
    <div class="row">
      <div>
        <label for="mode">××¦×‘ ×—×™×¤×•×©</label>
        <select id="mode">
          <option value="number" selected>×œ×¤×™ ××¡×¤×¨</option>
          <option value="text">×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</option>
        </select>
      </div>

      <div id="numWrap">
        <label for="value">××¡×¤×¨ ×’×™××˜×¨×™×”</label>
        <input id="value" type="number" min="0" placeholder="×œ×“×•×’××”: 347" />
      </div>

      <div id="txtWrap" style="display:none;">
        <label for="text">×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</label>
        <input id="text" type="text" placeholder="×œ×“×•×’××”: ×©×œ×•×" />
      </div>

      <div>
        <label for="kind">×¡×•×’ ×ª×•×¦××”</label>
        <select id="kind">
          <option value="">×”×›×•×œ</option>
          <option value="verse">×¤×¡×•×§×™×</option>
          <option value="word">××™×œ×™×</option>
          <option value="gram">×¨×¦×¤×™ ××™×œ×™×</option>
        </select>
      </div>

      <div>
        <label for="n">××•×¨×š ×¨×¦×£ (n)</label>
        <select id="n">
          <option value="">×›×œ ×”××•×¨×›×™×</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
        </select>
      </div>

      <div>
        <label for="limit">××§×¡×™××•× ×ª×•×¦××•×ª</label>
<select id="limit">
  <option value="" selected>×”×›×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
  <option value="25">25</option>
  <option value="50">50</option>
  <option value="100">100</option>
  <option value="200">200</option>
  <option value="500">500</option>
  <option value="1000">1000</option>
</select>
      </div>

      <div>
        <button id="btn">×—×¤×©</button>
      </div>
    </div>

    <div class="hint">
      ×‘××¦×‘ "×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª" ×”××¤×œ×™×§×¦×™×” ××—×©×‘×ª ×’×™××˜×¨×™×” (××ª×¢×œ××ª ×× ×™×§×•×“/×˜×¢××™×/×¤×™×¡×•×§) ×•××– ××—×¤×©×ª.<br/>
      ×”× ×ª×•× ×™× ××’×™×¢×™× ×Ö¾SQLite ××§×•××™ (tanakh.sqlite) ×‘×ª×•×š ×”×‘×× ×“×œ.
    </div>

    <div id="calc" class="note" style="display:none;"></div>
    <div id="err" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="meta" id="status">××•×›×Ÿ.</div>
      <div class="meta">API: <code>/search</code> â€¢ Gematria: <code>/gematria</code> â€¢ Docs: <code>/docs</code></div>
    </div>
    <div class="results" id="results"></div>
    <div class="footer" id="footer"></div>
  </div>
  </div><!-- End Search Tab -->

  <!-- Histogram (Verses) Tab Content -->
  <div id="histogramTab" class="tab-content">
    <div class="card no-top-radius">
      <h2 style="margin:0 0 12px;font-size:16px;color:#111827">ğŸ“Š ×”×™×¡×˜×•×’×¨××”: ×¤×¡×•×§×™× ×œ×¤×™ ×¢×¨×š ×’×™××˜×¨×™×”</h2>
      <p class="hint" style="margin-bottom:12px">×œ×—×¥ ×¢×œ ×¢××•×“×” ×œ×¨××•×ª ××ª ×”×¤×¡×•×§×™×. ×¦×‘×•×˜ ×œ×–×•×, ××• ×”×©×ª××© ×‘×›×¤×ª×•×¨×™×.</p>

      <div id="histogramStats" class="histogram-stats"></div>

      <div class="histogram-controls">
        <button onclick="zoomHistogram('verses', -0.2)">â– ×”×§×˜×Ÿ</button>
        <button onclick="zoomHistogram('verses', 0.2)">â• ×”×’×“×œ</button>
        <button onclick="resetZoom('verses')">â†º ××™×¤×•×¡</button>
        <span id="zoomInfoVerses" class="zoom-info">×–×•×: 100%</span>
      </div>

      <div id="histogramLoading" class="loading-histogram">
        <div class="spinner"></div>
        <div>×˜×•×¢×Ÿ × ×ª×•× ×™ ×”×™×¡×˜×•×’×¨××”...</div>
      </div>

      <div id="histogramContainer" class="histogram-container" style="display:none">
        <div id="histogramWrapper" class="histogram-wrapper">
          <div id="histogram" class="histogram"></div>
        </div>
      </div>
    </div>
  </div><!-- End Histogram Tab -->

  <!-- Histogram (Words) Tab Content -->
  <div id="histogramWordsTab" class="tab-content">
    <div class="card no-top-radius">
      <h2 style="margin:0 0 12px;font-size:16px;color:#111827">ğŸ“Š ×”×™×¡×˜×•×’×¨××”: ××™×œ×™× ×œ×¤×™ ×¢×¨×š ×’×™××˜×¨×™×”</h2>
      <p class="hint" style="margin-bottom:12px">×œ×—×¥ ×¢×œ ×¢××•×“×” ×œ×¨××•×ª ××ª ×”××™×œ×™×. ×¦×‘×•×˜ ×œ×–×•×, ××• ×”×©×ª××© ×‘×›×¤×ª×•×¨×™×.</p>

      <div id="histogramWordsStats" class="histogram-stats"></div>

      <div class="histogram-controls">
        <button onclick="zoomHistogram('words', -0.2)">â– ×”×§×˜×Ÿ</button>
        <button onclick="zoomHistogram('words', 0.2)">â• ×”×’×“×œ</button>
        <button onclick="resetZoom('words')">â†º ××™×¤×•×¡</button>
        <span id="zoomInfoWords" class="zoom-info">×–×•×: 100%</span>
      </div>

      <div id="histogramWordsLoading" class="loading-histogram">
        <div class="spinner"></div>
        <div>×˜×•×¢×Ÿ × ×ª×•× ×™ ×”×™×¡×˜×•×’×¨××”...</div>
      </div>

      <div id="histogramWordsContainer" class="histogram-container" style="display:none">
        <div id="histogramWordsWrapper" class="histogram-wrapper">
          <div id="histogramWords" class="histogram"></div>
        </div>
      </div>
    </div>
  </div><!-- End Histogram Words Tab -->
</main>

<!-- Modal for histogram details -->
<div id="modal" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 id="modalTitle">×’×™××˜×¨×™×”: 0</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

function showError(msg){
  $("err").style.display = msg ? "block" : "none";
  $("err").textContent = msg || "";
}

function showCalc(msg){
  $("calc").style.display = msg ? "block" : "none";
  $("calc").textContent = msg || "";
}

function kindLabel(k){
  if(k === "verse") return "×¤×¡×•×§";
  if(k === "word") return "××™×œ×”";
  if(k === "gram") return "×¨×¦×£";
  return k;
}

function syncMode(){
  const mode = $("mode").value;
  $("numWrap").style.display = (mode === "number") ? "block" : "none";
  $("txtWrap").style.display = (mode === "text") ? "block" : "none";
  showCalc("");
  showError("");
}
$("mode").addEventListener("change", syncMode);

async function doSearch(){
  showError("");
  showCalc("");

  const mode = $("mode").value;
  const kind = $("kind").value;
  const n = $("n").value;
  const limit = $("limit").value;

  const params = new URLSearchParams();
  if(limit) params.set("limit", limit);
  params.set("db", "tanakh.sqlite");
  if(kind) params.set("kind", kind);
  if(kind === "gram" && n) params.set("n", n);

  let computed = null;

  if(mode === "number"){
    const value = $("value").value.trim();
    if(!value){
      showError("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×’×™××˜×¨×™×”.");
      return;
    }
    params.set("value", value);
  }else{
    const text = $("text").value.trim();
    if(!text){
      showError("× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª.");
      return;
    }
    try{
      const gRes = await fetch("/gematria?text=" + encodeURIComponent(text));
      if(!gRes.ok) throw new Error("×œ× ×”×¦×œ×—×ª×™ ×œ×—×©×‘ ×’×™××˜×¨×™×” ×œ×˜×§×¡×˜.");
      const g = await gRes.json();
      computed = g.gematria;
      showCalc(`×”×’×™××˜×¨×™×” ×©×œ "${text}" ×”×™×: ${computed}`);
    }catch(e){
      showError(e.message || String(e));
      return;
    }
    params.set("text", text);
  }

  $("btn").disabled = true;
  $("status").textContent = "××—×¤×©...";
  $("results").innerHTML = "";
  $("footer").textContent = "";

  try{
    const res = await fetch("/search?" + params.toString());
    if(!res.ok){
      const txt = await res.text();
      throw new Error("×©×’×™××ª ×©×¨×ª: " + res.status + " " + txt);
    }
    const data = await res.json();

    $("status").textContent = `× ××¦××• ${data.length} ×ª×•×¦××•×ª.`;
    if(data.length === 0){
      $("results").innerHTML = "<div class='meta'>××™×Ÿ ×”×ª×××•×ª.</div>";
      return;
    }

    const frag = document.createDocumentFragment();
    data.forEach(h => {
      const div = document.createElement("div");
      div.className = "hit";
      const top = document.createElement("div");
      top.className = "top";
      const left = document.createElement("div");
      left.innerHTML = `<span class="ref">${h.ref}</span> <span class="pill">${kindLabel(h.kind)}${h.n ? " â€¢ n=" + h.n : ""}</span>`;
      const right = document.createElement("div");
      right.className = "meta";
      right.textContent = "×’×™××˜×¨×™×”: " + h.gematria;
      top.appendChild(left);
      top.appendChild(right);
      const textDiv = document.createElement("div");
      textDiv.className = "text";
      textDiv.textContent = h.text;
      div.appendChild(top);
      div.appendChild(textDiv);
      if(h.kind === "word" || h.kind === "gram"){
        const match = document.createElement("div");
        match.className = "small";
        const rng = h.match_range ? (" â€¢ " + h.match_range) : "";
        match.textContent = "×”×ª×××”: " + (h.match_text || "") + rng;
        div.appendChild(match);
      }
      const small = document.createElement("div");
      small.className = "small";
      small.textContent = "×˜×§×¡×˜ ×× ×•×¨××œ: " + h.clean_text;
      div.appendChild(small);
      frag.appendChild(div);
    });
    $("results").appendChild(frag);
    $("footer").textContent = "××¤×©×¨ ×œ×¤×ª×•×— /docs ×›×“×™ ×œ×‘×“×•×§ ××ª ×”Ö¾API ×•×œ×”×¨×™×¥ ×—×™×¤×•×©×™× × ×•×¡×¤×™×.";
  }catch(e){
    showError(e.message || String(e));
    $("status").textContent = "×ª×§×œ×”.";
  }finally{
    $("btn").disabled = false;
  }
}

$("btn").addEventListener("click", doSearch);
$("value").addEventListener("keydown", (e) => { if(e.key === "Enter") doSearch(); });
$("text").addEventListener("keydown", (e) => { if(e.key === "Enter") doSearch(); });

syncMode();

// ========== Tab Navigation ==========
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const targetTab = tab.dataset.tab;
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById(targetTab + 'Tab').classList.add('active');

    if (targetTab === 'histogram' && !histogramVersesLoaded) {
      loadHistogramVerses();
    }
    if (targetTab === 'histogramWords' && !histogramWordsLoaded) {
      loadHistogramWords();
    }
  });
});

// ========== Histogram Data ==========
let histogramVersesData = [];
let histogramWordsData = [];
let histogramVersesLoaded = false;
let histogramWordsLoaded = false;
let zoomLevels = { verses: 1, words: 1 };
let selectedBar = null;

// ========== Zoom Functions ==========
function zoomHistogram(type, delta) {
  zoomLevels[type] = Math.max(0.2, Math.min(5, zoomLevels[type] + delta));
  applyZoom(type);
}

function resetZoom(type) {
  zoomLevels[type] = 1;
  applyZoom(type);
}

function applyZoom(type) {
  const wrapper = type === 'verses' ? $('histogramWrapper') : $('histogramWordsWrapper');
  const info = type === 'verses' ? $('zoomInfoVerses') : $('zoomInfoWords');
  wrapper.style.transform = `scaleX(${zoomLevels[type]})`;
  info.textContent = `×–×•×: ${Math.round(zoomLevels[type] * 100)}%`;
}

// Pinch-to-zoom support
function setupPinchZoom(container, type) {
  let initialDistance = 0;
  let initialZoom = 1;

  container.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      initialDistance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      initialZoom = zoomLevels[type];
    }
  }, { passive: true });

  container.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      const currentDistance = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      const scale = currentDistance / initialDistance;
      zoomLevels[type] = Math.max(0.2, Math.min(5, initialZoom * scale));
      applyZoom(type);
    }
  }, { passive: true });
}

// ========== Load Verses Histogram ==========
async function loadHistogramVerses() {
  const loading = $('histogramLoading');
  const container = $('histogramContainer');
  const statsDiv = $('histogramStats');

  try {
    const res = await fetch('/histogram');
    if (!res.ok) throw new Error('Failed to load histogram data');

    histogramVersesData = await res.json();
    histogramVersesLoaded = true;

    const totalItems = histogramVersesData.reduce((sum, b) => sum + b.count, 0);
    const uniqueValues = histogramVersesData.length;
    const maxCount = Math.max(...histogramVersesData.map(b => b.count));
    const minGem = histogramVersesData[0]?.gematria || 0;
    const maxGem = histogramVersesData[histogramVersesData.length - 1]?.gematria || 0;

    statsDiv.innerHTML = `
      <div class="stat-item"><div class="stat-value">${totalItems.toLocaleString()}</div><div class="stat-label">×¡×”×´×› ×¤×¡×•×§×™×</div></div>
      <div class="stat-item"><div class="stat-value">${uniqueValues.toLocaleString()}</div><div class="stat-label">×¢×¨×›×™× ×©×•× ×™×</div></div>
      <div class="stat-item"><div class="stat-value">${minGem.toLocaleString()}-${maxGem.toLocaleString()}</div><div class="stat-label">×˜×•×•×—</div></div>
      <div class="stat-item"><div class="stat-value">${maxCount}</div><div class="stat-label">××§×¡×™××•×</div></div>
    `;

    renderHistogram('verses', histogramVersesData, $('histogram'), maxCount);
    setupPinchZoom(container, 'verses');

    loading.style.display = 'none';
    container.style.display = 'block';
  } catch (e) {
    loading.innerHTML = `<div class="error">×©×’×™××”: ${e.message}</div>`;
  }
}

// ========== Load Words Histogram ==========
async function loadHistogramWords() {
  const loading = $('histogramWordsLoading');
  const container = $('histogramWordsContainer');
  const statsDiv = $('histogramWordsStats');

  try {
    const res = await fetch('/histogram/words');
    if (!res.ok) throw new Error('Failed to load histogram data');

    histogramWordsData = await res.json();
    histogramWordsLoaded = true;

    const totalItems = histogramWordsData.reduce((sum, b) => sum + b.count, 0);
    const uniqueValues = histogramWordsData.length;
    const maxCount = Math.max(...histogramWordsData.map(b => b.count));
    const minGem = histogramWordsData[0]?.gematria || 0;
    const maxGem = histogramWordsData[histogramWordsData.length - 1]?.gematria || 0;

    statsDiv.innerHTML = `
      <div class="stat-item"><div class="stat-value">${totalItems.toLocaleString()}</div><div class="stat-label">×¡×”×´×› ××™×œ×™×</div></div>
      <div class="stat-item"><div class="stat-value">${uniqueValues.toLocaleString()}</div><div class="stat-label">×¢×¨×›×™× ×©×•× ×™×</div></div>
      <div class="stat-item"><div class="stat-value">${minGem.toLocaleString()}-${maxGem.toLocaleString()}</div><div class="stat-label">×˜×•×•×—</div></div>
      <div class="stat-item"><div class="stat-value">${maxCount}</div><div class="stat-label">××§×¡×™××•×</div></div>
    `;

    renderHistogram('words', histogramWordsData, $('histogramWords'), maxCount);
    setupPinchZoom(container, 'words');

    loading.style.display = 'none';
    container.style.display = 'block';
  } catch (e) {
    loading.innerHTML = `<div class="error">×©×’×™××”: ${e.message}</div>`;
  }
}

// ========== Render Histogram ==========
function renderHistogram(type, data, container, maxCount) {
  container.innerHTML = '';
  const height = 250;

  data.forEach((bucket, idx) => {
    const bar = document.createElement('div');
    bar.className = 'histogram-bar';
    const barHeight = Math.max(2, (bucket.count / maxCount) * height);
    bar.style.height = barHeight + 'px';

    bar.addEventListener('click', () => {
      // Deselect previous
      if (selectedBar) selectedBar.classList.remove('selected');
      bar.classList.add('selected');
      selectedBar = bar;
      showModal(type, bucket);
    });

    container.appendChild(bar);
  });
}

// ========== Modal ==========
function showModal(type, bucket) {
  const modal = $('modal');
  const title = $('modalTitle');
  const body = $('modalBody');

  const isVerses = type === 'verses';
  const items = isVerses ? bucket.verses : bucket.words;
  const itemLabel = isVerses ? '×¤×¡×•×§×™×' : '××™×œ×™×';

  title.textContent = `×’×™××˜×¨×™×”: ${bucket.gematria.toLocaleString()} (${bucket.count} ${itemLabel})`;

  const itemsHtml = items.slice(0, 100).map(item => {
    if (isVerses) {
      return `
        <div class="modal-item" onclick="searchFromModal(${bucket.gematria}, 'verse')">
          <div class="modal-item-ref">${item.ref}</div>
          <div class="modal-item-text">${item.text}</div>
        </div>
      `;
    } else {
      return `
        <div class="modal-item" onclick="searchFromModal(${bucket.gematria}, 'word')">
          <div class="modal-item-ref">${item.ref} <span class="modal-item-word">${item.word}</span></div>
          <div class="modal-item-text">${item.verse_text}</div>
        </div>
      `;
    }
  }).join('');

  const moreText = items.length > 100 ? `<div class="modal-stats">××¦×™×’ 100 ××ª×•×š ${items.length}</div>` : '';

  body.innerHTML = itemsHtml + moreText;
  modal.classList.add('visible');
}

function closeModal() {
  $('modal').classList.remove('visible');
  if (selectedBar) {
    selectedBar.classList.remove('selected');
    selectedBar = null;
  }
}

function searchFromModal(gematria, kind) {
  closeModal();
  tabs[0].click(); // Switch to search tab
  $('mode').value = 'number';
  syncMode();
  $('value').value = gematria;
  $('kind').value = kind;
  doSearch();
}

// Close modal on overlay click
$('modal').addEventListener('click', (e) => {
  if (e.target.id === 'modal') closeModal();
});

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});
</script>
</body>
</html>
