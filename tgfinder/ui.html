<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f6f7fb;}
    header{background:#111827;color:#fff;padding:16px 18px;}
    header h1{margin:0;font-size:20px;font-weight:700;}
    header p{margin:6px 0 0;opacity:.9;font-size:13px}
    main{padding:16px;max-width:1100px;margin:0 auto;}
    .card{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:14px;margin-bottom:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    label{font-size:13px;color:#374151;display:block;margin-bottom:6px}
    input,select{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;min-width:180px;font-size:14px;background:#fff}
    input[type="number"]{min-width:160px}
    input[type="text"]{min-width:260px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:700;font-size:14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .hint{font-size:12px;color:#6b7280;margin-top:10px;line-height:1.5}
    .results{margin-top:10px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;margin-inline-start:8px}
    .hit{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
    .hit .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .ref{font-weight:700;color:#111827}
    .meta{color:#6b7280;font-size:12px}
    .text{margin-top:8px;font-size:16px;line-height:1.7;color:#111827}
    .small{margin-top:6px;font-size:13px;color:#374151}
    .footer{margin-top:10px;color:#6b7280;font-size:12px}
    .error{color:#b91c1c;font-size:13px;margin-top:8px}
    .note{color:#374151;font-size:13px;margin-top:10px}
    /* Tab Navigation */
    .tabs{display:flex;gap:0;margin-bottom:0;background:#fff;border-radius:14px 14px 0 0;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .tab{flex:1;padding:14px 20px;text-align:center;cursor:pointer;font-weight:600;font-size:14px;color:#6b7280;border-bottom:3px solid transparent;transition:all .2s}
    .tab:hover{background:#f6f7fb;color:#374151}
    .tab.active{color:#2563eb;border-bottom-color:#2563eb;background:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card.no-top-radius{border-radius:0 0 14px 14px;margin-top:0}
    /* Histogram Styles */
    .histogram-container{position:relative;width:100%;overflow-x:auto;padding-bottom:20px}
    .histogram{display:flex;align-items:flex-end;gap:1px;min-height:300px;padding:20px 10px 40px;position:relative}
    .histogram-bar{background:linear-gradient(to top,#2563eb,#3b82f6);min-width:3px;cursor:pointer;border-radius:2px 2px 0 0;transition:background .2s,transform .1s;position:relative}
    .histogram-bar:hover{background:linear-gradient(to top,#1d4ed8,#2563eb);transform:scaleX(1.5)}
    .histogram-axis{position:absolute;bottom:0;left:10px;right:10px;border-top:2px solid #e5e7eb;height:30px}
    .histogram-label{font-size:11px;color:#6b7280;text-align:center;padding-top:8px}
    .histogram-stats{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:16px}
    .stat-item{background:#eef2ff;padding:10px 16px;border-radius:10px}
    .stat-value{font-size:20px;font-weight:700;color:#2563eb}
    .stat-label{font-size:12px;color:#6b7280;margin-top:2px}
    /* Tooltip */
    .tooltip{position:fixed;background:#111827;color:#fff;padding:12px 16px;border-radius:10px;font-size:13px;max-width:400px;z-index:1000;box-shadow:0 10px 40px rgba(0,0,0,.3);display:none;pointer-events:none}
    .tooltip.visible{display:block;pointer-events:auto}
    .tooltip-header{font-weight:700;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #374151}
    .tooltip-count{color:#93c5fd;font-size:12px}
    .tooltip-verses{max-height:200px;overflow-y:auto;margin-top:8px}
    .tooltip-verse{padding:8px;margin:4px 0;background:#1f2937;border-radius:6px;cursor:pointer;transition:background .2s}
    .tooltip-verse:hover{background:#374151}
    .tooltip-ref{font-weight:600;color:#93c5fd;margin-bottom:4px}
    .tooltip-text{font-size:12px;line-height:1.5;color:#d1d5db}
    .loading-histogram{text-align:center;padding:40px;color:#6b7280}
    .loading-histogram .spinner{border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<header>
  <h1>×—×™×¤×•×© ×’×™××˜×¨×™×” ×‘×ª× ×´×š</h1>
  <p>×—×¤×© ×œ×¤×™ ××¡×¤×¨ ××• ×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª (×”××¤×œ×™×§×¦×™×” ××—×©×‘×ª ×’×™××˜×¨×™×” ×•××– ××—×¤×©×ª ×”×ª×××•×ª).</p>
</header>

<main>
  <!-- Tab Navigation -->
  <div class="tabs">
    <div class="tab active" data-tab="search">ğŸ” ×—×™×¤×•×© ×’×™××˜×¨×™×”</div>
    <div class="tab" data-tab="histogram">ğŸ“Š ×”×™×¡×˜×•×’×¨××” ×œ×¤×™ ×’×™××˜×¨×™×”</div>
  </div>

  <!-- Search Tab Content -->
  <div id="searchTab" class="tab-content active">
  <div class="card no-top-radius">
    <div class="row">
      <div>
        <label for="mode">××¦×‘ ×—×™×¤×•×©</label>
        <select id="mode">
          <option value="number" selected>×œ×¤×™ ××¡×¤×¨</option>
          <option value="text">×œ×¤×™ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</option>
        </select>
      </div>

      <div id="numWrap">
        <label for="value">××¡×¤×¨ ×’×™××˜×¨×™×”</label>
        <input id="value" type="number" min="0" placeholder="×œ×“×•×’××”: 347" />
      </div>

      <div id="txtWrap" style="display:none;">
        <label for="text">×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª</label>
        <input id="text" type="text" placeholder="×œ×“×•×’××”: ×©×œ×•×" />
      </div>

      <div>
        <label for="kind">×¡×•×’ ×ª×•×¦××”</label>
        <select id="kind">
          <option value="">×”×›×•×œ</option>
          <option value="verse">×¤×¡×•×§×™×</option>
          <option value="word">××™×œ×™×</option>
          <option value="gram">×¨×¦×¤×™ ××™×œ×™×</option>
        </select>
      </div>

      <div>
        <label for="n">××•×¨×š ×¨×¦×£ (n)</label>
        <select id="n">
          <option value="">×›×œ ×”××•×¨×›×™×</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
          <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
        </select>
      </div>

      <div>
        <label for="limit">××§×¡×™××•× ×ª×•×¦××•×ª</label>
<select id="limit">
  <option value="" selected>×”×›×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
  <option value="25">25</option>
  <option value="50">50</option>
  <option value="100">100</option>
  <option value="200">200</option>
  <option value="500">500</option>
  <option value="1000">1000</option>
</select>
      </div>

      <div>
        <button id="btn">×—×¤×©</button>
      </div>
    </div>

    <div class="hint">
      ×‘××¦×‘ "×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª" ×”××¤×œ×™×§×¦×™×” ××—×©×‘×ª ×’×™××˜×¨×™×” (××ª×¢×œ××ª ×× ×™×§×•×“/×˜×¢××™×/×¤×™×¡×•×§) ×•××– ××—×¤×©×ª.<br/>
      ×”× ×ª×•× ×™× ××’×™×¢×™× ×Ö¾SQLite ××§×•××™ (tanakh.sqlite) ×‘×ª×•×š ×”×‘×× ×“×œ.
    </div>

    <div id="calc" class="note" style="display:none;"></div>
    <div id="err" class="error" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="meta" id="status">××•×›×Ÿ.</div>
      <div class="meta">API: <code>/search</code> â€¢ Gematria: <code>/gematria</code> â€¢ Docs: <code>/docs</code></div>
    </div>
    <div class="results" id="results"></div>
    <div class="footer" id="footer"></div>
  </div>
  </div><!-- End Search Tab -->

  <!-- Histogram Tab Content -->
  <div id="histogramTab" class="tab-content">
    <div class="card no-top-radius">
      <h2 style="margin:0 0 16px;font-size:18px;color:#111827">ğŸ“Š ×”×™×¡×˜×•×’×¨××”: ×¤×¡×•×§×™× ×œ×¤×™ ×¢×¨×š ×’×™××˜×¨×™×”</h2>
      <p class="hint" style="margin-bottom:16px">×›×œ ×¢××•×“×” ××™×™×¦×’×ª ×¢×¨×š ×’×™××˜×¨×™×”. ×¨×—×£ ××¢×œ ×¢××•×“×” ×œ×¨××•×ª ××ª ×”×¤×¡×•×§×™×. ×œ×—×¥ ×¢×œ ×¤×¡×•×§ ×œ×—×™×¤×•×© ××”×™×¨.</p>

      <div id="histogramStats" class="histogram-stats"></div>

      <div id="histogramLoading" class="loading-histogram">
        <div class="spinner"></div>
        <div>×˜×•×¢×Ÿ × ×ª×•× ×™ ×”×™×¡×˜×•×’×¨××”...</div>
      </div>

      <div id="histogramContainer" class="histogram-container" style="display:none">
        <div id="histogram" class="histogram"></div>
      </div>
    </div>
  </div><!-- End Histogram Tab -->

  <!-- Tooltip for histogram -->
  <div id="tooltip" class="tooltip"></div>
</main>

<script>
const $ = (id) => document.getElementById(id);

function showError(msg){
  $("err").style.display = msg ? "block" : "none";
  $("err").textContent = msg || "";
}

function showCalc(msg){
  $("calc").style.display = msg ? "block" : "none";
  $("calc").textContent = msg || "";
}

function kindLabel(k){
  if(k === "verse") return "×¤×¡×•×§";
  if(k === "word") return "××™×œ×”";
  if(k === "gram") return "×¨×¦×£";
  return k;
}

function syncMode(){
  const mode = $("mode").value;
  $("numWrap").style.display = (mode === "number") ? "block" : "none";
  $("txtWrap").style.display = (mode === "text") ? "block" : "none";
  showCalc("");
  showError("");
}
$("mode").addEventListener("change", syncMode);

async function doSearch(){
  showError("");
  showCalc("");

  const mode = $("mode").value;
  const kind = $("kind").value;
  const n = $("n").value;
  const limit = $("limit").value;

  const params = new URLSearchParams();
  if(limit) params.set("limit", limit);
  params.set("db", "tanakh.sqlite");
  if(kind) params.set("kind", kind);
  if(kind === "gram" && n) params.set("n", n);

  let computed = null;

  if(mode === "number"){
    const value = $("value").value.trim();
    if(!value){
      showError("× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×’×™××˜×¨×™×”.");
      return;
    }
    params.set("value", value);
  }else{
    const text = $("text").value.trim();
    if(!text){
      showError("× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×‘×¢×‘×¨×™×ª.");
      return;
    }
    // Ask server to compute gematria (so it's consistent with normalization)
    try{
      const gRes = await fetch("/gematria?text=" + encodeURIComponent(text));
      if(!gRes.ok) throw new Error("×œ× ×”×¦×œ×—×ª×™ ×œ×—×©×‘ ×’×™××˜×¨×™×” ×œ×˜×§×¡×˜.");
      const g = await gRes.json();
      computed = g.gematria;
      showCalc(`×”×’×™××˜×¨×™×” ×©×œ "${text}" ×”×™×: ${computed}`);
    }catch(e){
      showError(e.message || String(e));
      return;
    }
    params.set("text", text);
  }

  $("btn").disabled = true;
  $("status").textContent = "××—×¤×©...";
  $("results").innerHTML = "";
  $("footer").textContent = "";

  try{
    const res = await fetch("/search?" + params.toString());
    if(!res.ok){
      const txt = await res.text();
      throw new Error("×©×’×™××ª ×©×¨×ª: " + res.status + " " + txt);
    }
    const data = await res.json();

    $("status").textContent = `× ××¦××• ${data.length} ×ª×•×¦××•×ª.`;
    if(data.length === 0){
      $("results").innerHTML = "<div class='meta'>××™×Ÿ ×”×ª×××•×ª.</div>";
      return;
    }

    const frag = document.createDocumentFragment();
    data.forEach(h => {
  const div = document.createElement("div");
  div.className = "hit";

  const top = document.createElement("div");
  top.className = "top";

  const left = document.createElement("div");
  // Reference is already Hebrew from backend
  left.innerHTML = `<span class="ref">${h.ref}</span> <span class="pill">${kindLabel(h.kind)}${h.n ? " â€¢ n=" + h.n : ""}</span>`;

  const right = document.createElement("div");
  right.className = "meta";
  right.textContent = "×’×™××˜×¨×™×”: " + h.gematria;

  top.appendChild(left);
  top.appendChild(right);

  const textDiv = document.createElement("div");
  textDiv.className = "text";
  textDiv.textContent = h.text; // Always full verse

  div.appendChild(top);
  div.appendChild(textDiv);

  if(h.kind === "word" || h.kind === "gram"){
    const match = document.createElement("div");
    match.className = "small";
    const rng = h.match_range ? (" â€¢ " + h.match_range) : "";
    match.textContent = "×”×ª×××”: " + (h.match_text || "") + rng;
    div.appendChild(match);
  }

  const small = document.createElement("div");
  small.className = "small";
  small.textContent = "×˜×§×¡×˜ ×× ×•×¨××œ: " + h.clean_text;

  div.appendChild(small);
  frag.appendChild(div);
});
$("results").appendChild(frag);
    $("footer").textContent = "××¤×©×¨ ×œ×¤×ª×•×— /docs ×›×“×™ ×œ×‘×“×•×§ ××ª ×”Ö¾API ×•×œ×”×¨×™×¥ ×—×™×¤×•×©×™× × ×•×¡×¤×™×.";
  }catch(e){
    showError(e.message || String(e));
    $("status").textContent = "×ª×§×œ×”.";
  }finally{
    $("btn").disabled = false;
  }
}

$("btn").addEventListener("click", doSearch);
$("value").addEventListener("keydown", (e) => { if(e.key === "Enter") doSearch(); });
$("text").addEventListener("keydown", (e) => { if(e.key === "Enter") doSearch(); });

syncMode();

// ========== Tab Navigation ==========
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const targetTab = tab.dataset.tab;

    // Update active tab
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    // Show corresponding content
    tabContents.forEach(content => content.classList.remove('active'));
    document.getElementById(targetTab + 'Tab').classList.add('active');

    // Load histogram data on first view
    if (targetTab === 'histogram' && !histogramLoaded) {
      loadHistogram();
    }
  });
});

// ========== Histogram ==========
let histogramData = [];
let histogramLoaded = false;
const tooltip = document.getElementById('tooltip');

async function loadHistogram() {
  const loading = document.getElementById('histogramLoading');
  const container = document.getElementById('histogramContainer');
  const statsDiv = document.getElementById('histogramStats');

  try {
    const res = await fetch('/histogram');
    if (!res.ok) throw new Error('Failed to load histogram data');

    histogramData = await res.json();
    histogramLoaded = true;

    // Calculate stats
    const totalVerses = histogramData.reduce((sum, b) => sum + b.count, 0);
    const uniqueValues = histogramData.length;
    const maxCount = Math.max(...histogramData.map(b => b.count));
    const minGem = histogramData[0]?.gematria || 0;
    const maxGem = histogramData[histogramData.length - 1]?.gematria || 0;

    // Display stats
    statsDiv.innerHTML = `
      <div class="stat-item"><div class="stat-value">${totalVerses.toLocaleString()}</div><div class="stat-label">×¡×”×´×› ×¤×¡×•×§×™×</div></div>
      <div class="stat-item"><div class="stat-value">${uniqueValues.toLocaleString()}</div><div class="stat-label">×¢×¨×›×™ ×’×™××˜×¨×™×” ×©×•× ×™×</div></div>
      <div class="stat-item"><div class="stat-value">${minGem.toLocaleString()} - ${maxGem.toLocaleString()}</div><div class="stat-label">×˜×•×•×— ×¢×¨×›×™×</div></div>
      <div class="stat-item"><div class="stat-value">${maxCount}</div><div class="stat-label">××§×¡×™××•× ×¤×¡×•×§×™× ×œ×¢×¨×š</div></div>
    `;

    // Render histogram
    renderHistogram(maxCount);

    loading.style.display = 'none';
    container.style.display = 'block';

  } catch (e) {
    loading.innerHTML = `<div class="error">×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×: ${e.message}</div>`;
  }
}

function renderHistogram(maxCount) {
  const histogramDiv = document.getElementById('histogram');
  histogramDiv.innerHTML = '';

  const height = 250; // max bar height in pixels

  histogramData.forEach((bucket, idx) => {
    const bar = document.createElement('div');
    bar.className = 'histogram-bar';
    const barHeight = Math.max(2, (bucket.count / maxCount) * height);
    bar.style.height = barHeight + 'px';
    bar.dataset.index = idx;

    bar.addEventListener('mouseenter', (e) => showTooltip(e, bucket));
    bar.addEventListener('mouseleave', hideTooltip);
    bar.addEventListener('mousemove', moveTooltip);

    histogramDiv.appendChild(bar);
  });
}

function showTooltip(e, bucket) {
  const versesHtml = bucket.verses.slice(0, 50).map(v => `
    <div class="tooltip-verse" data-gematria="${bucket.gematria}" data-ref="${v.ref}">
      <div class="tooltip-ref">${v.ref}</div>
      <div class="tooltip-text">${v.text.substring(0, 100)}${v.text.length > 100 ? '...' : ''}</div>
    </div>
  `).join('');

  const moreText = bucket.verses.length > 50 ? `<div style="color:#93c5fd;font-size:11px;margin-top:8px">...×•×¢×•×“ ${bucket.verses.length - 50} ×¤×¡×•×§×™×</div>` : '';

  tooltip.innerHTML = `
    <div class="tooltip-header">
      ×’×™××˜×¨×™×”: ${bucket.gematria.toLocaleString()}
      <span class="tooltip-count">(${bucket.count} ×¤×¡×•×§×™×)</span>
    </div>
    <div class="tooltip-verses">${versesHtml}${moreText}</div>
  `;

  // Add click handlers for verses
  tooltip.querySelectorAll('.tooltip-verse').forEach(el => {
    el.addEventListener('click', () => {
      const gem = el.dataset.gematria;
      // Switch to search tab and search for this gematria
      tabs[0].click(); // Switch to search tab
      $('mode').value = 'number';
      syncMode();
      $('value').value = gem;
      $('kind').value = 'verse';
      doSearch();
      hideTooltip();
    });
  });

  tooltip.classList.add('visible');
  moveTooltip(e);
}

function moveTooltip(e) {
  const tooltipRect = tooltip.getBoundingClientRect();
  let x = e.clientX + 15;
  let y = e.clientY + 15;

  // Keep tooltip in viewport
  if (x + tooltipRect.width > window.innerWidth - 20) {
    x = e.clientX - tooltipRect.width - 15;
  }
  if (y + tooltipRect.height > window.innerHeight - 20) {
    y = e.clientY - tooltipRect.height - 15;
  }

  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
}

function hideTooltip() {
  // Small delay to allow clicking on tooltip content
  setTimeout(() => {
    if (!tooltip.matches(':hover')) {
      tooltip.classList.remove('visible');
    }
  }, 100);
}

// Keep tooltip visible when hovering over it
tooltip.addEventListener('mouseleave', () => {
  tooltip.classList.remove('visible');
});
</script>
</body>
</html>
